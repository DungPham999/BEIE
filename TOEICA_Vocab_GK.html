<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Vocabulary Quiz</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 20px auto;
      padding: 0 16px;
      background-color: #fff7e6;
      line-height: 1.5;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
    }
    .info {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px 12px;
      margin-bottom: 12px;
      background-color: #fafafa;
    }
    .info p { margin: 4px 0; }
    #timer {
      font-weight: bold;
      color: #d9534f;
    }
    .quiz-box {
      border: 1px solid #eee;
      border-radius: 6px;
      padding: 14px 16px;
      background: #ffffff;
      margin-bottom: 16px;
    }
    .vn-text {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .audio-wrapper {
      margin: 8px 0 12px 0;
    }
    audio {
      width: 100%;
    }
  
    .audio-frame {
  width: 100%;
  height: 80px;        /* có thể tăng/giảm */
  border: 0;
  margin: 8px 0 10px 0;
}

    
    .answer-wrapper {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    #answerInput {
      flex: 1;
      min-width: 180px;
      padding: 6px 8px;
      font-size: 16px;
    }
    .btn {
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid #888;
      background-color: #f5f5f5;
      cursor: pointer;
      font-size: 14px;
    }
    .btn:hover { background-color: #e0e0e0; }
    .btn:disabled {
      opacity: 0.6;
      cursor: default;
    }
    #feedback {
      margin-top: 10px;
      font-size: 15px;
      padding: 6px 8px;
      border-radius: 4px;
    }
    #feedback.ok {
      background-color: #e6ffe6;
      color: #155724;
      border: 1px solid #b7e0b7;
    }
    #feedback.ng {
      background-color: #ffe6e6;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status-line {
      margin-top: 8px;
      font-size: 14px;
    }
    .result-box {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px 14px;
      background: #fff;
      display: none;
    }
    .result-main {
      font-size: 24px;
      font-weight: bold;
      color: #007acc;
      margin: 6px 0;
    }
    .footer {
      text-align: center;
      margin-top: 30px;
      padding: 16px 0;
      color: #444;
      font-size: 13px;
      opacity: 0.85;
    }

    /* ===== TỐI ƯU CHO MÀN HÌNH NHỎ (ĐIỆN THOẠI) ===== */
@media (max-width: 600px) {
  body {
    max-width: 100%;
    margin: 0;
    padding: 8px 10px;
    font-size: 16px;         /* chữ to hơn một chút */
  }

  h1 {
    font-size: 22px;
    margin: 12px 0;
    text-align: center;
  }

  .info {
    padding: 10px;
  }

  .info label {
    display: block;
    margin-bottom: 6px;
  }

  .info input {
    width: 100%;             /* ô nhập Họ tên / Lớp full chiều ngang */
    box-sizing: border-box;
    margin-top: 3px;
    padding: 8px 10px;
    font-size: 16px;
  }

  .quiz-box {
    padding: 10px 10px;
  }

  .vn-text {
    font-size: 18px;
  }

  .audio-frame {
    height: 100px;           /* to hơn chút cho dễ bấm nút play */
  }

  .answer-wrapper {
    flex-direction: column;  /* input và nút xếp theo cột */
    align-items: stretch;
    gap: 6px;
  }

  #answerInput {
    font-size: 18px;
    padding: 10px 12px;
  }

  .btn {
    font-size: 16px;
    padding: 10px 14px;
    width: 100%;             /* nút rộng cả dòng, dễ bấm */
    text-align: center;
  }

  .status-line {
    font-size: 14px;
  }

  #feedback {
    font-size: 14px;
  }

  .result-main {
    font-size: 20px;
  }
}

    
  </style>
</head>
<body>
 <h1 id="title"></h1>


  <div class="info">
    <p><strong>Thời gian làm bài:</strong> <span id="timer">00:00</span></p>

    <p><strong>Mục tiêu:</strong> làm đúng <span id="targetCorrectText">--</span> câu để hoàn thành.</p>
    <p>
      <label>Họ tên học viên:
        <input type="text" id="studentName" placeholder="Nguyễn Văn A" />
      </label>
    </p>
    <p>
      <label>Lớp / Nhóm:
        <input type="text" id="studentClass" placeholder="VD: TOEIC Reading 1" />
      </label>
    </p>
  </div>

  <div class="quiz-box" id="quizBox">
    <div class="status-line">
      Câu đúng: <span id="correctCount">0</span> /
      Câu đã làm: <span id="totalDone">0</span>
    </div>
    <hr />

    <div class="vn-text" id="vnText">Đang tải câu hỏi...</div>

    <div class="audio-wrapper">
     
      <!-- Dùng iframe giống IELTS -->
<iframe
  id="audioFrame"
  class="audio-frame"
  allow="autoplay">
</iframe>

      
    </div>

    <div class="answer-wrapper">
      <input
        type="text"
        id="answerInput"
        placeholder="Gõ đáp án tiếng Anh..."
        autocomplete="off"
      />
      <button class="btn" id="checkBtn">Check</button>
      <button class="btn" id="nextBtn" style="display:none;">Câu tiếp</button>
    </div>

    <div id="feedback"></div>
  </div>

  <div class="result-box" id="resultBox">
    <div><strong>Kết quả bài làm:</strong></div>
    <div class="result-main" id="resultScore"></div>
    <div id="resultDetail"></div>
  </div>

  <div class="footer">
    © <span id="year"></span> Online Practice by Dung Phạm. All rights reserved.
  </div>

<script>
  // ========= CẤU HÌNH =========
  // Tự lấy tên file hiện tại làm TestID
const TEST_ID = location.pathname.split('/').pop().replace('.html','') || 'DefaultTest';

  const TARGET_CORRECT = 30;          // số câu cần đúng để kết thúc
  const TIME_LIMIT_MINUTES = 20;      // thời gian tối đa (phút)
  const LOG_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwv8q--sVh5XrXUS7ZIHCK-VLltJesaT5NmV1cCw1tliN938Rm5iHgWAR_4MeJUmKMh/exec';
    // Mỗi lần mở trang -> 1 attemptId riêng
  const ATTEMPT_ID = Date.now().toString(36) + '-' + Math.random().toString(36).slice(2, 8);

  // ========= NGÂN HÀNG CÂU HỎI =========
  // Copy 4 cột: ID | VN | Answer | Audio (KHÔNG lấy dòng tiêu đề)
  // từ Google Sheets và dán vào giữa cặp ` ... ` dưới đây.
  const RAW_DATA = `

559	ghi nhận mức tăng trưởng doanh thu cao nhất	to record the highest revenue growth	https://drive.google.com/file/d/1uHcSqgctniRWAo1Ez49GsgRgV5w5hlbb/view?usp=drivesdk
560	được cố định an toàn	be safely secured	https://drive.google.com/file/d/17Uxzz875mzocjh9fEjK_-TguWmPZerwM/view?usp=drivesdk
561	nhà ở miễn phí do công ty cung cấp	free company housing	https://drive.google.com/file/d/13cx6gSGn2xEg4SmS3yaEeoL6KJ5aL0hX/view?usp=drivesdk
562	khoản trợ cấp	a stipend	https://drive.google.com/file/d/1fnr3LCGbtfk3VFqx8OzN9UuEPDUwtrVK/view?usp=drivesdk
563	tất cả các buổi hòa nhạc của họ	every one of its concerts	https://drive.google.com/file/d/1Z0lEUvbWOnScLlHq8EcMQPiSrB18MOzO/view?usp=drivesdk
564	kéo dài vài giờ	to last several hours	https://drive.google.com/file/d/1xFgFAgReBGanCnd6J9dP-STCV-VsJ4Lh/view?usp=drivesdk
565	lái xe thận trọng	to drive cautiously	https://drive.google.com/file/d/10c8LB1xWnGwyibFD67XZ4UtJg1iZ8pbC/view?usp=drivesdk
566	việc loại bỏ tất cả thực phẩm	the elimination of all foods	https://drive.google.com/file/d/1_cap1bKVdXBThy_wdxrWft8Jh_dcNoVG/view?usp=drivesdk
567	khả năng đáng chú ý	a remarkable ability	https://drive.google.com/file/d/1DI-Y5PGcHRjL_2xXq2_rnqdy4Q_FtgxD/view?usp=drivesdk
568	mang lại lợi ích về tài chính	be financially beneficial	https://drive.google.com/file/d/1oVOedV0H0IafGeSSjj0vjoas6qlkHEHH/view?usp=drivesdk
569	tỷ lệ luân chuyển nhân sự	employee turnover	https://drive.google.com/file/d/1mlkTL2443_B1lTMP56oDcjFOVGZbiykl/view?usp=drivesdk
570	các phương pháp canh tác nông nghiệp	agricultural practices	https://drive.google.com/file/d/1JbG9VIzhPXJlYSrnLw7t2Ex_186G_iEn/view?usp=drivesdk
571	diễn giả khai mạc	the opening speaker	https://drive.google.com/file/d/1aDNk06LnJNYPIjh3pUpwWFQemhrguMfB/view?usp=drivesdk
572	bữa trưa phục vụ theo suất	a catered lunch	https://drive.google.com/file/d/1x6Izv-lKgcQlV4IErJY9bu-2-h7TBi-e/view?usp=drivesdk
573	nằm trong các nội dung/ sự việc/ vật thể	be among the items	https://drive.google.com/file/d/1bVP9zvW0iJB5hfpXKP08HBGMhe1L8ja6/view?usp=drivesdk
574	duy trì sự trung thành với doanh nghiệp	to remain faithful to a company	https://drive.google.com/file/d/1O2Qfo1EobTw4RCqevxYF2Vko64hhAw1B/view?usp=drivesdk
575	có trong bản tin nội bộ	be featured in our newsletter	https://drive.google.com/file/d/1BqutaGePzW1umPoIkZtWg4gJsb6nKg0f/view?usp=drivesdk
576	việc công bố báo cáo lợi nhuận	the release of the earnings report	https://drive.google.com/file/d/11D54CLcbJJJeo3nQVVkcHTzq12cNjopK/view?usp=drivesdk
577	làm việc cùng các thực tập sinh	to work alongside interns	https://drive.google.com/file/d/1jdxKuffaSa2s_yTd33A_T9cOQ9OaG4qP/view?usp=drivesdk
578	giám sát chất lượng công việc	to monitor the quality of work	https://drive.google.com/file/d/1pK2ufS2ol4MzP470asW1OixK3KQVU_5g/view?usp=drivesdk
579	đủ việc cần làm	enough to do	https://drive.google.com/file/d/1OzQgP0DaPtuWNj4EGA2PpzhXIi_zBZul/view?usp=drivesdk
580	đại lý được cấp phép	a licensed agent	https://drive.google.com/file/d/17u69g0JUePx_wWz2Agaq_b1JsQpINXRO/view?usp=drivesdk
581	các điều khoản của hợp đồng	the terms of the contract	https://drive.google.com/file/d/1Uw4eouEXCbJY1R0SXuH-ABR2njDYSN4s/view?usp=drivesdk
582	ngay khi các điều khoản được hoàn tất	as soon as the terms are finalized	https://drive.google.com/file/d/1KJF0y_ojeCnAfpAZRHVd-EiuexrrQZW-/view?usp=drivesdk
583	sự quan sát một hành tinh	an observation of a planet	https://drive.google.com/file/d/1W-hbqLE6weNnkj7My2Q60Gtvfp5O3xtO/view?usp=drivesdk
584	chính thức mở cửa lần đầu	to open its doors for the first time	https://drive.google.com/file/d/1PL32D5r1XdZH7nORzeR0Q29E68yw0_7k/view?usp=drivesdk
585	chi nhánh nhượng quyền mới	a new franchise	https://drive.google.com/file/d/12MzczY3aqS11Q56vEJvOP5Ohn6ODEZq_/view?usp=drivesdk
586	nhiều loại bánh mì kẹp	a variety of sandwiches	https://drive.google.com/file/d/1myG62BAL9_W-EtinyNeo0zNobL29wZ8Y/view?usp=drivesdk
587	không giống hầu hết các chi nhánh	unlike most franchises	https://drive.google.com/file/d/1k1ztkNT3Mk35TGa-zPRPxT3Prhhv14mk/view?usp=drivesdk
588	do xung đột lịch trình	due to a scheduling conflict	https://drive.google.com/file/d/1FvLXKpnfylk7mJ5gAR7XumKXATf6-T-J/view?usp=drivesdk
589	đổi vé	to exchange tickets	https://drive.google.com/file/d/1U2FL_oMtHorggxtNYfc3aCsuDf794011/view?usp=drivesdk
590	chỗ ngồi còn trống	available seats	https://drive.google.com/file/d/1oAkr0VF-ZpOXyyCA7IiehTq3g3v4sYZo/view?usp=drivesdk
591	liên hệ với người giữ vé	to get in touch with ticket holders	https://drive.google.com/file/d/1kQDM2NyW0ZMiwziUd-Qfi70dHfhszSEy/view?usp=drivesdk
592	thời hạn muộn nhất	the latest deadline	https://drive.google.com/file/d/1tPPqvyOTOXrFVwyo7rtQU6YG-bmQO6ac/view?usp=drivesdk
593	chuyển ra khỏi căn hộ	to move out of an apartment	https://drive.google.com/file/d/1ZBVM4OWe_1bQ0RpTKXIhYsfDx9rSqR9F/view?usp=drivesdk
594	rời khỏi mặt bằng	to vacate the premises	https://drive.google.com/file/d/1QcsRqHAiCUcayKOd7fvvsYklrCxPg4Ok/view?usp=drivesdk
595	tiền đặt cọc	a security deposit	https://drive.google.com/file/d/1AscIvxWapt2KfUTKxCAAn3mENfroGrqY/view?usp=drivesdk
596	xin lỗi vì thông báo gấp	to apologize for short notice	https://drive.google.com/file/d/1usRUHHtM-_FAQr_2tNZTbhYt7LG6rj2X/view?usp=drivesdk
597	cho kiểm tra căn hộ	to have an apartment inspected	https://drive.google.com/file/d/1o4ddoODJQ5shr_SZgVFOrbeGH7vee5Gu/view?usp=drivesdk
598	xem lại lịch trình	to look over the itinerary	https://drive.google.com/file/d/1SCEoaz9hYkqQfzomC5Ot_oCLiTBbpA4z/view?usp=drivesdk
599	thời điểm khởi hành chuyến bay	a flight departure time	https://drive.google.com/file/d/17kxiWdt6WTxzHseU4IPOGyZbv171Nv9Y/view?usp=drivesdk
600	đại diện cho công ty	to represent a company	https://drive.google.com/file/d/1YiYYmJz5YF8efHenptUeWTBI14EVy3S3/view?usp=drivesdk
601	làm quen với khách hàng	to get to know customers	https://drive.google.com/file/d/1Xk5G_1e3x2XxXctR8Qg-Ndq17M8vhbvd/view?usp=drivesdk
602	chỉ vào một vị trí trên bản đồ	to point at a location on a map	https://drive.google.com/file/d/1ISKbWplpRLOHNKxTG5BSCooI8htIicym/view?usp=drivesdk
603	dán biển báo lên tường	to tape a sign to the wall	https://drive.google.com/file/d/1UrwFvfJ1reyMs64kHHX_uLLzqq9dllfT/view?usp=drivesdk
604	thò tay vào túi xách	to reach into her bag	https://drive.google.com/file/d/1oxYygCjvWIdLEniS2F1S49gATwno0obv/view?usp=drivesdk
605	tấm thảm cuộn kẹp dưới cánh tay	a rolled mat under her arm	https://drive.google.com/file/d/1y7g44HtuzHq4CGdIydtUfhDDB0szbLID/view?usp=drivesdk
606	trụ sở chính của công ty	the corporate headquarters	https://drive.google.com/file/d/1uZSA6Ks_Lj1MlcKCBkcwKhDkCN-h2QRX/view?usp=drivesdk
607	phòng khám tư nhân	a private practice	https://drive.google.com/file/d/1xmhqiyDInQE5cMpsYwazVGPuyTX3vzW2/view?usp=drivesdk
608	gia hạn hợp đồng	to renew a contract	https://drive.google.com/file/d/1gq8kmQgyd0ilx6Q2QBp1-0H8lYcK9JpH/view?usp=drivesdk
609	sửa chữa xe nâng	to repair a forklift	https://drive.google.com/file/d/1v6jy1iJABgIbWF3sje-u4VIphYu9e8DH/view?usp=drivesdk
610	gửi thông báo nhắc lịch hẹn	to send an appointment reminder	https://drive.google.com/file/d/1zTh47lBhh0FASyufhKKw_t0ZucaQLslG/view?usp=drivesdk
611	rất cảm kích điều đó	to appreciate that	https://drive.google.com/file/d/1Igohe4I376kNRX03U4uTAggdWtFmmgkL/view?usp=drivesdk
612	được cho là đang giảm giá	be supposed to be discounted	https://drive.google.com/file/d/1_XbBkKDBzVNalzfsviNAqu8amXhpmYaw/view?usp=drivesdk
613	bắt đầu đóng gói hành lý cho chuyến đi	to start packing for a trip	https://drive.google.com/file/d/1y4EEhl3tHgsZxGU25WiVjoW5iPB5F8U5/view?usp=drivesdk
614	trước khoảng hai ngày	about two days in advance	https://drive.google.com/file/d/1Q2QTUobGx8BmAF_syIWyZMPLWX6clDwH/view?usp=drivesdk
615	sắp xếp hàng lên kệ	to stock the shelves	https://drive.google.com/file/d/1bMX-v68xkBCWpJIHs5s2xvE4TV4pk1UM/view?usp=drivesdk
616	nhân viên làm ca đêm	the overnight workers	https://drive.google.com/file/d/17xvJK2NU8PJRmfz2NabNfIODm9bik7-f/view?usp=drivesdk
617	đảm bảo có sẵn	to make sure something is available	https://drive.google.com/file/d/1b4JJm3Kkm3Nt-xsI1OlJSTsjIxjkgR7l/view?usp=drivesdk
618	danh sách đăng ký	a sign-up sheet	https://drive.google.com/file/d/1aAz9sxmq6Pnanptb0kOXi-xicW_KVmsP/view?usp=drivesdk
619	hướng dẫn ở trên hộp	the instructions on the box	https://drive.google.com/file/d/1vrhIZztH2t2wR9i1E73nQOpfDyC-RawK/view?usp=drivesdk
620	thông cáo báo chí	a press release	https://drive.google.com/file/d/1YGhUw62k3PA3aAiibIBLAHfVldQLcRSf/view?usp=drivesdk
621	giữ thiết bị ở trạng thái bật	to keep something turned on	https://drive.google.com/file/d/18wlMLkN6U75NOfQVC6Xk1uUvlDYkthvT/view?usp=drivesdk
622	nhập mã số trên bàn phím	to enter a passcode on the keypad	https://drive.google.com/file/d/1EOhgBCCpuHrSHMerjBXtganyJR1bY7tq/view?usp=drivesdk
623	thợ sửa xe ở gần đó	the mechanic around the corner	https://drive.google.com/file/d/1oJH_utjaBiOOatLc26weLMyRYokbKApn/view?usp=drivesdk
624	quy trình phức tạp	a complicated process	https://drive.google.com/file/d/1qBlxJ_N2-gjTBpuQUJq36z6iJ2hYEuCK/view?usp=drivesdk
625	được cố định an toàn	be firmly fastened	https://drive.google.com/file/d/1m_qCJbRxAvmkPUqRcMn92fbic84JPR9r/view?usp=drivesdk
626	nhà ở miễn phí do công ty cung cấp	complimentary company accommodation	https://drive.google.com/file/d/1skuw8nxMbABYXfKQ4ePKMNJQk6LvJTdd/view?usp=drivesdk
627	khoản trợ cấp	an allowance	https://drive.google.com/file/d/1CWjuybUGVHOfpP_0xMKZ09rd9CxTIb1r/view?usp=drivesdk
628	tất cả các buổi hòa nhạc của họ	all of its performances	https://drive.google.com/file/d/1ndUQ-ArouHo1ZOmNIaHk4caDHRjS9i-0/view?usp=drivesdk
629	kéo dài vài giờ	to continue for several hours	https://drive.google.com/file/d/1v1AyKCMtlnV-adTmiicgchwYXDerSMOW/view?usp=drivesdk
630	lái xe thận trọng	to drive carefully	https://drive.google.com/file/d/1jJiarKaUOUKcFXxggbOXwSRUL27rqaqq/view?usp=drivesdk
631	việc loại bỏ tất cả thực phẩm	the removal of all foods	https://drive.google.com/file/d/1LlhvCSPwZ2PdcZIZaup_Ey_knWdnoifI/view?usp=drivesdk
632	khả năng đáng chú ý	an outstanding ability	https://drive.google.com/file/d/151sm4VzItr6q_BSm2xVjMox2D5TeCrLD/view?usp=drivesdk
633	mang lại lợi ích về tài chính	be economically advantageous	https://drive.google.com/file/d/1nViyg-sS6cHLc0T5j9WwXjffAIur9VeG/view?usp=drivesdk
634	tỷ lệ luân chuyển nhân sự	staff turnover	https://drive.google.com/file/d/1NLgi1Pf1lbuZJjzDbAaOIA6TrJfY-L18/view?usp=drivesdk
635	các phương pháp canh tác nông nghiệp	farming practices	https://drive.google.com/file/d/14BlZ648uwsREKVEwQb49axQ9-BMr8Z0Y/view?usp=drivesdk
636	diễn giả khai mạc	the keynote speaker	https://drive.google.com/file/d/1aUUySXppPZ6Oj7qBiEfmioIg-anGIcQQ/view?usp=drivesdk
637	bữa trưa phục vụ theo suất	a provided lunch	https://drive.google.com/file/d/1QX0Auj8wTjQq2_mNiUgqtl8sTVwdJtAM/view?usp=drivesdk
638	duy trì sự trung thành với doanh nghiệp	to stay loyal to a company	https://drive.google.com/file/d/1ltZJyV4FnUZiH3k43OKsVP5PALup5o-t/view?usp=drivesdk
639	việc công bố báo cáo lợi nhuận	the publication of the earnings report	https://drive.google.com/file/d/1rauFrd_d86_nvMc94duXWhGfuO0-baYW/view?usp=drivesdk
640	làm việc cùng các thực tập sinh	to collaborate with interns	https://drive.google.com/file/d/1ScGd8_EeeBcjxAAbQamQI2czQYvN6Iag/view?usp=drivesdk
641	giám sát chất lượng công việc	to oversee work quality	https://drive.google.com/file/d/1qNjeDGDVlqEI0bfimU47RrHDXMZVHo6v/view?usp=drivesdk
642	đủ việc cần làm	sufficient workload	https://drive.google.com/file/d/1wcm-1xFrtW50v1hDdATqYbfgSbVjWaTD/view?usp=drivesdk
643	đại lý được cấp phép	a certified agent	https://drive.google.com/file/d/11eow0MnPdI7tq5YQ2JBqXwzPR_CTdebS/view?usp=drivesdk
644	các điều khoản của hợp đồng	the contract conditions	https://drive.google.com/file/d/1Gz6ku0f6pDxFvXyOLMX2a-QNEvlURUqn/view?usp=drivesdk
645	ngay khi các điều khoản được hoàn tất	once the terms are finalized	https://drive.google.com/file/d/15I_9EXwjFo6llZMqr2ezujJT8NTLI6z9/view?usp=drivesdk
646	sự quan sát một hành tinh	a planetary observation	https://drive.google.com/file/d/1eHh-LNal9IWzL-Htv5ToR7HQLJwwYWmt/view?usp=drivesdk
647	chính thức mở cửa lần đầu	to launch operations	https://drive.google.com/file/d/1eb_h26_jgmeM4TFR9V_IkC0xRFtWk6N1/view?usp=drivesdk
648	chi nhánh nhượng quyền mới	a new branch	https://drive.google.com/file/d/1yTcqJoMXou33ylGY6aB9v3WjezaeRxPG/view?usp=drivesdk
649	nhiều loại bánh mì kẹp	a range of sandwiches	https://drive.google.com/file/d/10Ihvx0PqUVDZ8dciQBdUDRHe70cgWavk/view?usp=drivesdk
650	không giống hầu hết các chi nhánh	in contrast to most franchises	https://drive.google.com/file/d/12ayST6Wc3St8jekj9JoG8PHljdNg223V/view?usp=drivesdk
651	đổi vé	to swap tickets	https://drive.google.com/file/d/10wgSTBjdxo0fwVkdjUGRQ88lYEciS3MT/view?usp=drivesdk
652	chỗ ngồi còn trống	vacant seats	https://drive.google.com/file/d/1iCAIOLXfhV5hWeaICKloPWYt3YVeaJtq/view?usp=drivesdk
653	liên hệ với người giữ vé	to contact ticket holders	https://drive.google.com/file/d/18BEc0aSNMlpvlow8hdAUjLRGz0ZOYHLG/view?usp=drivesdk
654	thời hạn muộn nhất	the final deadline	https://drive.google.com/file/d/1PZkeDRDsNb2_3njhcRfPdA9H8wJ3px62/view?usp=drivesdk
655	chuyển ra khỏi căn hộ	to vacate an apartment	https://drive.google.com/file/d/1WU9NgPz77tXkd9t2mgmxzqIHpKdvIS16/view?usp=drivesdk
656	rời khỏi mặt bằng	to leave the premises	https://drive.google.com/file/d/1H0mheYFz3zru4I-M5lb94M9lAOzU1E0s/view?usp=drivesdk
657	tiền đặt cọc	a damage deposit	https://drive.google.com/file/d/1XP0GM6ny7chKOXgAvPH-7W7LN3th0dyV/view?usp=drivesdk
658	xin lỗi vì thông báo gấp	to express regret for short notice	https://drive.google.com/file/d/121Bh21V1mg1zB3LXh2MLkTIPYnt2gOP2/view?usp=drivesdk
659	cho kiểm tra căn hộ	to request an apartment inspection	https://drive.google.com/file/d/13c7kWCGZEm4rzB17ycoAIutyi2nBwKa6/view?usp=drivesdk
660	xem lại lịch trình	to review the itinerary	https://drive.google.com/file/d/1gkOuC_pXPA0eRt4pRUml3CXeqADvItm9/view?usp=drivesdk
661	đại diện cho công ty	to act on behalf of a company	https://drive.google.com/file/d/1NIAQ0dii83hHTe6-Km6HdHpS_HHzlq8M/view?usp=drivesdk
662	làm quen với khách hàng	to become acquainted with clients	https://drive.google.com/file/d/1b1aZkUA0_HmhyNg08U6vrYbG-GfwndNa/view?usp=drivesdk
663	chỉ vào một vị trí trên bản đồ	to indicate a spot on a map	https://drive.google.com/file/d/118UZpPUm7HXwyaGEAosAfoq59VJpQIVh/view?usp=drivesdk
664	dán biển báo lên tường	to attach a sign to the wall	https://drive.google.com/file/d/12z_ORMjbo9d2WIGK0Q1dOKXLph-TjB3G/view?usp=drivesdk
665	thò tay vào túi xách	to put her hand into her bag	https://drive.google.com/file/d/1BNNXYeHCO6OdKIvfKsaTiD8gU-OVkj2L/view?usp=drivesdk
666	phòng khám tư nhân	an independent clinic	https://drive.google.com/file/d/1kNsAhEk5dITmuPZfmR57t7XBKoKC9ryu/view?usp=drivesdk
667	gia hạn hợp đồng	to extend a contract	https://drive.google.com/file/d/1KfVFR0pLzcHb1dnfj-11IC3OctxyPW5y/view?usp=drivesdk
668	sửa chữa xe nâng	to fix a forklift	https://drive.google.com/file/d/1tTSnqxhIAKF5DXYq0gw6wq0JWFXcGWlq/view?usp=drivesdk
669	gửi thông báo nhắc lịch hẹn	to send a meeting reminder	https://drive.google.com/file/d/1jMcW98HMFpBL2kT8J_My9ROTk9kmouXj/view?usp=drivesdk
670	rất cảm kích điều đó	to be grateful for that	https://drive.google.com/file/d/1ERWjHMEzTvPMSHUQUdPrZLAjA5hkQ7T0/view?usp=drivesdk
671	được cho là đang giảm giá	be expected to be on sale	https://drive.google.com/file/d/16mT-1ueN8p1k-4FRaOGCqGk7mCDYyA2g/view?usp=drivesdk
672	bắt đầu đóng gói hành lý cho chuyến đi	to begin preparing luggage	https://drive.google.com/file/d/1Xn8w1pQouNV7i9yMN0OnD0LDz68p2o35/view?usp=drivesdk
673	trước khoảng hai ngày	roughly two days beforehand	https://drive.google.com/file/d/1E7V1zQyaHQ0mbXcRtHZ4P_OcDbD0Jslr/view?usp=drivesdk
674	sắp xếp hàng lên kệ	to replenish shelves	https://drive.google.com/file/d/1eDvQQFGImC1VJ3JSuArXR9brmhyKNYZl/view?usp=drivesdk
675	nhân viên làm ca đêm	night-shift workers	https://drive.google.com/file/d/1-WCzb6zFxDHoOJj9TY3vJKHcWHVn2dlZ/view?usp=drivesdk
676	đảm bảo có sẵn	to ensure availability	https://drive.google.com/file/d/14EGkzEZFS2RhjhlfHpHELK2bix8U9UIj/view?usp=drivesdk
677	danh sách đăng ký	a registration sheet	https://drive.google.com/file/d/1WzROZV-juKSyMxdTRRt0z2CKQUfUDPm4/view?usp=drivesdk
678	hướng dẫn sử dụng	the user manual	https://drive.google.com/file/d/1GJ9_kl5wUyGrnoghV_ZxDWfqmTSkXa1W/view?usp=drivesdk
679	giữ thiết bị ở trạng thái bật	to leave something on	https://drive.google.com/file/d/1NrbdstOUkNv6N257Abyvl8RNzepd8t3s/view?usp=drivesdk
680	nhập mã số trên bàn phím	to input an access code	https://drive.google.com/file/d/1gNkXGyIxY_qjQPS0wd-sTn7Ex35ayWOn/view?usp=drivesdk
681	thợ sửa xe ở gần đó	a nearby mechanic	https://drive.google.com/file/d/1YFVvi4-XaYGWi9Rat8K1vYoaz-ULsL6Q/view?usp=drivesdk
682	quy trình phức tạp	a complex procedure	https://drive.google.com/file/d/1qSrcLJ6KeE-OXXgvd9LfuwO-HGh3QzlH/view?usp=drivesdk

`; // <-- THAY BẰNG DỮ LIỆU THẬT CỦA THẦY

  // ========= CODE CHUNG =========

function normalize(str) {
  return (str || '')
    .normalize('NFC')                       // chuẩn hoá Unicode
    .replace(/[\u200B-\u200D\uFEFF]/g, '') // xoá ký tự zero-width
    .toLowerCase()
    .replace(/[’‘`]/g, "'")                // ’ ‘ `  -> '
    .replace(/[.,!?;:]+$/g, '')            // xoá . , ? ! ; : ở CUỐI chuỗi
    .replace(/\s+/g, ' ')
    .trim();
}
// Chuẩn hoá chuỗi sao cho a / an / the được coi là cùng một "loại" ARTICLE
function normalizeArticles(str) {
  const tokens = (str || '').split(' ').filter(Boolean);
  const mapped = tokens.map(t => {
    return (t === 'a' || t === 'an' || t === 'the') ? 'ARTICLE' : t;
  });
  return mapped.join(' ');
}



  function parseBank(raw) {
    const lines = raw.trim().split('\n').filter(l => l.trim() !== '');
    const items = [];
    lines.forEach(line => {
      const cols = line.split('\t');
      if (cols.length < 4) return;
      const id    = (cols[0] || '').trim();
      const vn    = (cols[1] || '').trim();
      const ans   = (cols[2] || '').trim();
      const audio = (cols[3] || '').trim();
      if (!vn || !ans) return;
      items.push({ id, vn, answer: ans, audio });
    });
    return items;
  }

  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

 
function sendLog(payload, useBeacon = false) {
  if (!LOG_ENDPOINT || !LOG_ENDPOINT.startsWith('http')) return;

  const data = JSON.stringify(payload);

  // Nếu dùng cho beforeunload thì ưu tiên sendBeacon
  if (useBeacon && navigator.sendBeacon) {
    navigator.sendBeacon(LOG_ENDPOINT, data);
  } else {
    // Còn lại dùng fetch bình thường
    fetch(LOG_ENDPOINT, {
      method: 'POST',
      mode: 'no-cors',
      keepalive: useBeacon,          // cho case beforeunload
      headers: { 'Content-Type': 'application/json' },
      body: data
    }).catch(() => {});
  }
}


 let bank = [];
let currentIndex = 0;
let correctCount = 0;
let totalDone = 0;
let quizFinished = false;

// Timer đếm lên
let startTime = null;
let timerInterval = null;
let elapsedSec = 0;        // số giây đã làm

// Đánh dấu đã ghi log hay chưa (để tránh ghi 2 lần)
let hasLogged = false;

  const vnTextEl = document.getElementById('vnText');
// LẤY IFRAME THAY VÌ AUDIO
const audioFrame = document.getElementById('audioFrame');
  const answerInput = document.getElementById('answerInput');
  const checkBtn = document.getElementById('checkBtn');
  const nextBtn = document.getElementById('nextBtn');
  const feedbackEl = document.getElementById('feedback');
  const correctCountEl = document.getElementById('correctCount');
  const totalDoneEl = document.getElementById('totalDone');
  const timerEl = document.getElementById('timer');
  const resultBox = document.getElementById('resultBox');
  const resultScore = document.getElementById('resultScore');
  const resultDetail = document.getElementById('resultDetail');

  document.getElementById('targetCorrectText').textContent = TARGET_CORRECT;
  document.getElementById('year').textContent = new Date().getFullYear();

function startTimer() {
  startTime = new Date();
  elapsedSec = 0;

  function renderTime() {
    const m = Math.floor(elapsedSec / 60);
    const s = elapsedSec % 60;
    timerEl.textContent =
      String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
  }

  renderTime();

  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    elapsedSec++;
    renderTime();
  }, 1000);
}

  
// Chuyển link Google Drive thành link preview cho iframe
function getDrivePreviewUrl(url) {
  if (!url) return '';
  url = url.trim();

  // Chỉ xử lý nếu là link Google Drive
  if (/drive\.google\.com/.test(url)) {
    let id = '';

    // Trường hợp: .../file/d/FILE_ID/view?...
    const m1 = url.match(/\/d\/([^\/]+)/);

    // Trường hợp: ...open?id=FILE_ID...
    const m2 = url.match(/[?&]id=([^&]+)/);

    if (m1 && m1[1]) {
      id = m1[1];
    } else if (m2 && m2[1]) {
      id = m2[1];
    }

    if (id) {
      // Link /preview cho iframe
      return 'https://drive.google.com/file/d/' + id + '/preview';
    }
  }

  // Nếu không phải Drive thì trả lại nguyên link
  return url;
}

  function showQuestion() {
  if (quizFinished) return;

  if (bank.length === 0) {
    vnTextEl.textContent = 'Không có câu hỏi nào trong ngân hàng.';
    return;
  }

  if (currentIndex >= bank.length) {
    shuffle(bank);
    currentIndex = 0;
  }

  const q = bank[currentIndex];
  vnTextEl.textContent = q.vn;

  // DÙNG LINK /preview CHO IFRAME
  const previewUrl = getDrivePreviewUrl(q.audio);
  audioFrame.src = previewUrl;

  answerInput.value = '';
  answerInput.disabled = false;
  answerInput.focus();

  feedbackEl.textContent = '';
  feedbackEl.className = '';
  checkBtn.disabled = false;
  nextBtn.style.display = 'none';
}



  function checkAnswer() {
    if (quizFinished) return;

    const name = (document.getElementById('studentName').value || '').trim();
    const cls  = (document.getElementById('studentClass').value || '').trim();
    if (!name || !cls) {
      alert('Vui lòng nhập HỌ TÊN và LỚP/NHÓM trước khi làm bài.');
      return;
    }

    const q = bank[currentIndex];
    const user = normalize(answerInput.value);
    if (!user) {
      alert('Hãy gõ đáp án trước khi bấm Check.');
      return;
    }

    // danh sách đáp án chấp nhận, phân biệt số ít/số nhiều (không can thiệp)
    const acceptable = q.answer
      .split('|')
      .map(a => normalize(a))
      .filter(a => a);
   
    // ĐÚNG nếu:
  // 1) Trùng hoàn toàn sau normalize()
  // 2) Hoặc trùng sau khi quy tất cả a/an/the -> ARTICLE
  const isCorrect = acceptable.some(ans => (
    ans === user ||
    normalizeArticles(ans) === normalizeArticles(user)
  ));

    totalDone++;
    
   

    if (isCorrect) {
      correctCount++;
      feedbackEl.className = 'ok';
      feedbackEl.textContent = 'Đúng. Đáp án: ' + q.answer;
    } else {
      feedbackEl.className = 'ng';
      feedbackEl.textContent = 'Sai. Đáp án đúng: ' + q.answer;
    }

    correctCountEl.textContent = correctCount;
    totalDoneEl.textContent = totalDone;

    answerInput.disabled = true;
    checkBtn.disabled = true;
    nextBtn.style.display = 'inline-block';

    // >>> GHI LOG TIẾN ĐỘ MỖI LẦN HỌC SINH NHẤN CHECK
    logProgress();

    if (correctCount >= TARGET_CORRECT) {
      finishQuiz('Bạn đã hoàn thành đủ ' + TARGET_CORRECT + ' câu đúng.');
    }
  }

  function finishQuiz(reasonText) {
  if (quizFinished) return;
  quizFinished = true;
  hasLogged = true;   // đánh dấu đã ghi log để onbeforeunload không gửi nữa

  if (timerInterval) clearInterval(timerInterval);
  answerInput.disabled = true;
  checkBtn.disabled = true;
  nextBtn.disabled = true;

  const durationSec = elapsedSec;
  const percent = totalDone > 0
    ? Math.round((correctCount * 100) / totalDone)
    : 0;

  // Format thời gian: X phút YY giây (hiển thị cho học sinh)
  const mm = Math.floor(durationSec / 60);
  const ss = durationSec % 60;
  const timeText = `${mm} phút ${String(ss).padStart(2, '0')} giây`;

  resultBox.style.display = 'block';
  resultScore.textContent = `${percent}% chính xác`;
  resultDetail.innerHTML =
    `Bài test: <strong>${TEST_ID}</strong><br>` +
    `Đúng ${correctCount} / ${totalDone} câu.<br>` +
    `Thời gian làm bài: ${timeText}.<br>` +
    (reasonText ? `Kết thúc: ${reasonText}.` : '');

  const name = (document.getElementById('studentName').value || '').trim() || 'NoName';
  const cls  = (document.getElementById('studentClass').value || '').trim();
  const timestamp = new Date().toLocaleString();

  // hh:mm:ss cho log
  const hh = Math.floor(durationSec / 3600);
  const mm2 = Math.floor((durationSec % 3600) / 60);
  const ss2 = durationSec % 60;
  const durationHMS =
    String(hh).padStart(2, '0') + ':' +
    String(mm2).padStart(2, '0') + ':' +
    String(ss2).padStart(2, '0');

  const rawLog =
    name + '\t' +
    cls + '\t' +
    TEST_ID + '\t' +
    timestamp + '\t' +
    correctCount + '\t' +
    totalDone + '\t' +
    percent + '\t' +
    durationHMS;

  const payload = {
    attemptId: ATTEMPT_ID,   // rất quan trọng để ghi đè 1 dòng
    testId: TEST_ID,
    name: name,
    className: cls,
    correct: correctCount,
    total: totalDone,
    percent: percent,
    duration: durationSec,
    rawLog: rawLog,
    status: 'finished'
  };

  // Gửi log dùng fetch thường
  sendLog(payload, false);
}

// GHI LOG TIẾN ĐỘ MỖI LẦN NHẤN CHECK
function logProgress() {
  const name = (document.getElementById('studentName').value || '').trim() || 'NoName';
  const cls  = (document.getElementById('studentClass').value || '').trim();

  const durationSec = elapsedSec;
  const percent = totalDone > 0
    ? Math.round((correctCount * 100) / totalDone)
    : 0;

  const timestamp = new Date().toLocaleString();

  // Đổi duration sang hh:mm:ss để nhìn cho dễ trong RawLog
  const hh  = Math.floor(durationSec / 3600);
  const mm2 = Math.floor((durationSec % 3600) / 60);
  const ss2 = durationSec % 60;
  const durationHMS =
    String(hh).padStart(2, '0') + ':' +
    String(mm2).padStart(2, '0') + ':' +
    String(ss2).padStart(2, '0');

  const rawLog =
    name + '\t' +
    cls + '\t' +
    TEST_ID + '\t' +
    timestamp + '\t' +
    correctCount + '\t' +
    totalDone + '\t' +
    percent + '\t' +
    durationHMS;

  const payload = {
    attemptId: ATTEMPT_ID,   // cùng AttemptId -> luôn ghi đè 1 dòng
    testId: TEST_ID,
    name: name,
    className: cls,
    correct: correctCount,
    total: totalDone,
    percent: percent,
    duration: durationSec,
    rawLog: rawLog,
    status: 'progress'       // khác với finished / aborted
  };

  // Gửi log bình thường
  sendLog(payload, false);
}


  // ====== GẮN SỰ KIỆN ======
  checkBtn.addEventListener('click', checkAnswer);
  nextBtn.addEventListener('click', () => {
    if (quizFinished) return;
    currentIndex++;
    showQuestion();
  });

  answerInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      if (!checkBtn.disabled) {
        checkAnswer();
      } else if (!nextBtn.disabled && nextBtn.style.display !== 'none') {
        nextBtn.click();
      }
    }
  });

  // ====== KHỞI ĐỘNG ======
  (function init() {
    bank = parseBank(RAW_DATA);
    if (!bank.length) {
      vnTextEl.textContent = 'Không có dữ liệu trong RAW_DATA.';
      return;
    }
    shuffle(bank);
    startTimer();
    showQuestion();
  })();
document.getElementById('title').textContent = TEST_ID;

  
// ====== GHI LOG KHI HỌC SINH THOÁT GIỮA CHỪNG ======
window.addEventListener('beforeunload', (event) => {
  // Nếu đã finishQuiz() thì không log nữa
  if (hasLogged) return;

  // Nếu chưa làm gì (chưa trả lời câu nào) thì khỏi log
  if (totalDone === 0) return;

  const name = (document.getElementById('studentName').value || '').trim() || 'NoName';
  const cls  = (document.getElementById('studentClass').value || '').trim();

  const durationSec = elapsedSec;
  const percent = totalDone > 0
    ? Math.round((correctCount * 100) / totalDone)
    : 0;

  const timestamp = new Date().toLocaleString();

  // hh:mm:ss
  const hh = Math.floor(durationSec / 3600);
  const mm2 = Math.floor((durationSec % 3600) / 60);
  const ss2 = durationSec % 60;
  const durationHMS =
    String(hh).padStart(2, '0') + ':' +
    String(mm2).padStart(2, '0') + ':' +
    String(ss2).padStart(2, '0');

  const rawLog =
    name + '\t' +
    cls + '\t' +
    TEST_ID + '\t' +
    timestamp + '\t' +
    correctCount + '\t' +
    totalDone + '\t' +
    percent + '\t' +
    durationHMS + '\tThoát giữa chừng';

  const payload = {
    attemptId: ATTEMPT_ID,   // dùng cùng attemptId -> ghi đè đúng dòng
    testId: TEST_ID,
    name: name,
    className: cls,
    correct: correctCount,
    total: totalDone,
    percent: percent,
    duration: durationSec,
    rawLog: rawLog,
    status: 'aborted'
  };

  hasLogged = true;

  // Gửi log bằng sendBeacon (useBeacon = true)
  sendLog(payload, true);
});



  
</script>
</body>
</html>
