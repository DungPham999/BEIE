<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- TỐI ƯU CHO ĐIỆN THOẠI -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IELTS Listening & Reading – Practice Test</title>
<style>
  :root{
    --page-max: 1400px;
    --gap: 16px;
    --bg: #fff7e6;
    --card: #fafafa;
    --white: #fff;
    --line: #ddd;
    --accent: #007acc;
  }

  body{
    font-family: Arial, sans-serif;
    max-width: var(--page-max);
    margin: 16px auto;
    padding: 0 16px;
    line-height: 1.5;
    background: var(--bg);
    font-size: 16px;
  }

  h1{
    text-align: center;
    margin: 10px 0;
    font-size: 26px;
  }

  h2{
    margin: 10px 0 8px;
    font-size: 18px;
    border-bottom: 1px solid #ccc;
    padding-bottom: 4px;
  }

  .info, .group-block, .result{
    border: 1px solid var(--line);
    border-radius: 6px;
    padding: 10px 12px;
    background: var(--card);
  }
  .info{ margin-bottom: 12px; font-size: 15px; }
  .group-block{ margin-bottom: 15px; border-color: #eee; }
  .result{ margin-top: 12px; background: var(--white); font-size: 15px; }

  .info input{
    padding: 6px 8px;
    font-size: 15px;
  }

  .passage{
    margin: 8px 0 12px;
    padding: 8px 10px;
    border-left: 3px solid var(--accent);
    background: var(--white);
    font-size: 14px;
  }

  .question{
    margin-bottom: 12px;
    padding: 8px 8px 10px;
    border-bottom: 1px dashed var(--line);
    background: var(--white);
    font-size: 15px;
  }
  .question.correct{ background: #e6ffe6; }
  .question.incorrect{ background: #ffe6e6; }
  .question-number{ font-weight: bold; }

  #timer{ font-weight: bold; color: #d9534f; }

  .short-answer-input{
    width: 80%;
    max-width: 400px;
    padding: 6px 8px;
    font-size: 15px;
  }

  audio{ width: 100%; margin: 8px 0 10px; }

  iframe.audio-frame{
    width: 100%;
    height: 80px;
    border: 0;
    margin: 8px 0 10px;
  }

  img.q-img{
    max-width: 100%;
    height: auto;
    margin: 6px 0;
    display: block;
  }

  .img-frame{
    width: 100%;
    height: 420px; /* đề lớn hơn trên desktop */
    border: 0;
    margin: 6px 0;
    display: block;
  }

  .btn{
    padding: 8px 14px;
    border-radius: 4px;
    border: 1px solid #888;
    background: #f5f5f5;
    cursor: pointer;
    font-size: 15px;
  }
  .btn:hover{ background: #e0e0e0; }

  .btn-row{
    display: flex;
    justify-content: center;
    gap: 20px;
    margin: 20px 0;
    flex-wrap: wrap;
  }

  .footer{
    text-align: center;
    margin-top: 40px;
    padding: 20px 0;
    color: #444;
    font-size: 14px;
    opacity: 0.85;
  }

  /* ===== Reading: trái rộng – phải hẹp ===== */
  .reading-layout{
    display: grid;
    grid-template-columns: minmax(0, 1fr) clamp(220px, 24vw, 320px);
    gap: var(--gap);
    align-items: start;
    margin-bottom: 15px;
  }
  .reading-left, .reading-right{ min-width: 0; }

  .reading-right{
    position: sticky;
    top: 12px;
  }

  .reading-right label{
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 6px 0;
    font-size: 15px;
    line-height: 1.25;
  }

  .reading-right input[type="radio"]{
    transform: scale(1.05);
  }

  /* ===== Mobile ===== */
  @media (max-width: 768px){
    body{
      max-width: 100%;
      margin: 0;
      padding: 10px 8px 30px;
    }

    h1{ font-size: 22px; }

    .info label{ display: block; margin-bottom: 6px; }
    .info input{
      width: 100%;
      box-sizing: border-box;
      margin-top: 4px;
    }

    .reading-layout{
      grid-template-columns: 1fr; /* xếp dọc */
      gap: 12px;
    }

    .reading-right{ position: static; top: auto; }

    .img-frame{ height: 300px; }

    .short-answer-input{
      width: 100%;
      max-width: 100%;
    }

    .btn-row{
      flex-direction: column;
      align-items: stretch;
      gap: 10px;
    }

    .btn-row .btn{
      width: 100%;
      font-size: 16px;
      padding: 10px 0;
    }
  }
</style>

  
</head>
<body>
 <h1 id="pageTitle">Đang tải tiêu đề...</h1>

  <div class="info">
    <p><strong>Thời gian làm bài còn lại:</strong> <span id="timer">--:--</span></p>
    <p>Làm xong hãy bấm <strong>Nộp bài</strong> để xem điểm. Có thể tải lại trang để làm lại.</p>
    <p>
      <label>Họ tên học viên:
        <input type="text" id="studentName" placeholder="Nguyễn Văn A">
      </label>
    </p>
    <p>
      <label>Lớp / Nhóm:
        <input type="text" id="studentClass" placeholder="VD: 8A, TOEIC-Reading 1">
      </label>
    </p>
  </div>

  <div id="quiz"></div>

  <div class="btn-row">
    <button class="btn" id="submitBtn">Nộp bài & xem kết quả</button>
    <button class="btn" id="retryBtn">Làm lại từ đầu</button>
  </div>

  <div class="result" id="resultBox" style="display:none;"></div>

<script>
// ====== CẤU HÌNH CHO GIÁO VIÊN ======
const DURATION_MINUTES = 35

// Lấy TEST_ID từ tên file hiện tại, ví dụ "BEIE_HW_U6.html"
const fileSegment = location.pathname.split('/').pop() || '';
const TEST_ID = decodeURIComponent(
  fileSegment.replace(/\.[^/.]+$/, '')
) || 'PracticeTest';

// Cập nhật tiêu đề trang và H1 ngay khi tải
document.title = TEST_ID;
const pageTitleEl = document.getElementById('pageTitle');
if (pageTitleEl) {
  pageTitleEl.textContent = TEST_ID;
}

const META_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSwmXatD1TfDmC8mB6GBhN_KLZ4mh8NKV_QtuDNVf3dDYNwA2gLvtSVKzb-VRUaP9ILG_vKThvALITu/pub?output=csv";

function parseMetaCSV(text) {
  const lines = text.trim().split("\n");
  if (lines.length < 2) return [];
  const header = lines[0].split(",").map(h => h.trim());
  const rows = lines.slice(1);
  return rows.map(row => {
    const cols = row.split(",");
    const obj = {};
    header.forEach((h, i) => { obj[h] = (cols[i] || "").trim(); });
    return obj;
  });
}

async function loadTestTitle() {
  try {
    const resp = await fetch(META_CSV_URL);
    const text = await resp.text();
    const data = parseMetaCSV(text);
    const currentFile = location.pathname.split("/").pop();
    const meta = data.find(r =>
      (r.File || "").toLowerCase() === (currentFile || "").toLowerCase()
    );
    const h1 = document.getElementById("pageTitle");
    if (meta && meta.Title) {
      document.title = meta.Title;
      if (h1) h1.textContent = meta.Title;
    } else if (h1 && h1.textContent === "Đang tải tiêu đề...") {
      h1.textContent = "Practice Test";
    }
  } catch (err) {
    console.error("Không đọc được meta CSV:", err);
    const h1 = document.getElementById("pageTitle");
    if (h1 && h1.textContent === "Đang tải tiêu đề...") {
      h1.textContent = "Practice Test";
    }
  }
}

const LOG_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwv8q--sVh5XrXUS7ZIHCK-VLltJesaT5NmV1cCw1tliN938Rm5iHgWAR_4MeJUmKMh/exec';

// ----- DỮ LIỆU ĐỀ -----
const RAW_DATA = `

222	reading	2024_Aug_Int_A_R1	1	mcq	[img:https://drive.google.com/file/d/10SIT-qGVR29qceOwhZwwUUAfzBCBSyp0/view?usp=drive_link]		A	B	C	D	a
223	reading	2024_Aug_Int_A_R1	2	mcq	[img:https://drive.google.com/file/d/13nhk1-VHmtRR9tobg4dJ5dmRjfblWrMn/view?usp=drive_link]		A	B	C	D	b
224	reading	2024_Aug_Int_A_R1	3	mcq	[img:https://drive.google.com/file/d/1LkM_H3eFDKIjKSFqYq1rwuXdxuq3XEvO/view?usp=drive_link]		A	B	C	D	c
225	reading	2024_Aug_Int_A_R1	4	mcq	[img:https://drive.google.com/file/d/165Y3I5iejBbXtqh9H8VwLxSQ67QQA5ul/view?usp=drive_link]		A	B	C	D	d
226	reading	2024_Aug_Int_A_R1	5	mcq	[img:https://drive.google.com/file/d/1nL2XvTdECmBWtEY18BxuWdWakVI0IQAD/view?usp=drive_link]		A	B	C	D	b
227	reading	2024_Aug_Int_A_R1	6	mcq	[img:https://drive.google.com/file/d/1ZqFhbdI6EdySzSEI2sXMw9lPAqsnePUa/view?usp=drive_link]		A	B	C	D	d
228	reading	2024_Aug_Int_A_R1	7	mcq	[img:https://drive.google.com/file/d/19AAay6hv6bj1lat7bVZXIyHuxNFHQ8VL/view?usp=drive_link]		A	B	C	D	d
229	reading	2024_Aug_Int_A_R1	8	mcq	[img:https://drive.google.com/file/d/1gkjvkaADYny7On2U1CozRwYr_xy8Hblr/view?usp=drive_link]		A	B	C	D	d
230	reading	2024_Aug_Int_A_R1	9	mcq	[img:https://drive.google.com/file/d/11jxDxTu0ISsohAvFL07baX52O6UVHGy0/view?usp=drive_link]		A	B	C	D	a
231	reading	2024_Aug_Int_A_R1	10	mcq	[img:https://drive.google.com/file/d/1ChQHwGacy0b7PR5CqAXGnK-epQ5tJzfe/view?usp=drive_link]		A	B	C	D	lôi
232	reading	2024_Aug_Int_A_R1	11	mcq	[img:https://drive.google.com/file/d/1_619UgTfky7eZbGhoPizPO_Cs2jfsx2E/view?usp=drive_link]		A	B	C	D	c
233	reading	2024_Aug_Int_A_R1	12	mcq	[img:https://drive.google.com/file/d/1KlY7PICX2QixkEc8ISRFbm3DiP7zd_x0/view?usp=drive_link]		A	B	C	D	loi
234	reading	2024_Aug_Int_A_R1	13	mcq	[img:https://drive.google.com/file/d/1YeLanWsVTc5gT9u7Ei5dE9F-hUllj7ah/view?usp=drive_link]		A	B	C	D	a
235	reading	2024_Aug_Int_A_R1	14	mcq	[img:https://drive.google.com/file/d/1Y7mPWuu-xkaEeJowmAbLWWLZiIMtWPbY/view?usp=drive_link]		A	B	C	D	c
236	reading	2024_Aug_Int_A_R1	15	mcq	[img:https://drive.google.com/file/d/1vyISzrs5WSp8aKGfJ4SrbVgIf537q09z/view?usp=drive_link]		A	B	C	D	d
237	reading	2024_Aug_Int_A_R1	16	mcq	[img:https://drive.google.com/file/d/1HiFS1I6A8kL_VSueWAOZbo9yePGFlLXa/view?usp=drive_link]		A	B	C	D	c
238	reading	2024_Aug_Int_A_R1	17	mcq	[img:https://drive.google.com/file/d/1SSJ5mfNROGK8xDqXro1jZAlpMsX1G-sx/view?usp=drive_link]		A	B	C	D	a
239	reading	2024_Aug_Int_A_R1	18	mcq	[img:https://drive.google.com/file/d/1di84TL6S9qQrqkStlR4ovFvDG57xMTN7/view?usp=drive_link]		A	B	C	D	c
240	reading	2024_Aug_Int_A_R1	19	mcq	[img:https://drive.google.com/file/d/19HVAx3k_tVbY6yFos19Z9q9M1bk_pGq5/view?usp=drive_link]		A	B	C	D	d
241	reading	2024_Aug_Int_A_R1	20	mcq	[img:https://drive.google.com/file/d/1UjLkneNXMa43J_ivVrMVnRowuODFuxXe/view?usp=drive_link]		A	B	C	D	c
242	reading	2024_Aug_Int_A_R1	21	mcq	[img:https://drive.google.com/file/d/130VxfpRmtmDrD8dO38gj20Q0sK6Zz8xK/view?usp=drive_link]		A	B	C	D	d
243	reading	2024_Aug_Int_A_R1	22	mcq	[img:https://drive.google.com/file/d/1yiIvMc63AglMUdKdE0EJr9oWOXkGWOsP/view?usp=drive_link]		A	B	C	D	c
244	reading	2024_Aug_Int_A_R1	23	mcq	[img:https://drive.google.com/file/d/1QCHl0wlbqjgqrfQprt9F_syuMXqPorjp/view?usp=drive_link]		A	B	C	D	a
245	reading	2024_Aug_Int_A_R1	24	mcq	[img:https://drive.google.com/file/d/1p25SM6Pt8vHmsP3rYCCw1bC0Dbi4a09u/view?usp=drive_link]		A	B	C	D	a
246	reading	2024_Aug_Int_A_R1	25	mcq	[img:https://drive.google.com/file/d/1NPvBsq428XLBDM1LhMUnm6P-_CekcFks/view?usp=drive_link]		A	B	C	D	b
247	reading	2024_Aug_Int_A_R1	26	mcq	[img:https://drive.google.com/file/d/1VDC-iejizKBC-O-pYa9vKiFUZKJc60Iz/view?usp=drive_link]		A	B	C	D	c
248	reading	2024_Aug_Int_A_R1	27	mcq	[img:https://drive.google.com/file/d/1JMQa4njiWQWEtu2riTij-dwevbnT3m6P/view?usp=drive_link]		A	B	C	D	a

`;

// ====== CODE CHUNG ======
let timerInterval = null;
let timeLeft = 0;

function startTimer(totalSeconds) {
  timeLeft = totalSeconds;
  const timerEl = document.getElementById('timer');
  if (timerInterval) clearInterval(timerInterval);

  function updateDisplay() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    timerEl.textContent =
      String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
  }
  updateDisplay();

  timerInterval = setInterval(() => {
    timeLeft--;
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      timeLeft = 0;
      updateDisplay();
      alert('Hết thời gian! Hệ thống sẽ tự chấm điểm.');
      gradeQuiz();
    } else {
      updateDisplay();
    }
  }, 1000);
}

function escapeHtml(str) {
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

function renderImgToken(urlRaw) {
  const url = urlRaw.trim();
  if (/drive\.google\.com/i.test(url)) {
    let id = '';
    const m1 = url.match(/\/d\/([^\/]+)/);
    const m2 = url.match(/[?&]id=([^&]+)/);
    if (m1 && m1[1]) id = m1[1];
    else if (m2 && m2[1]) id = m2[1];
    if (id) {
      const preview = 'https://drive.google.com/file/d/' + id + '/preview';
      return '<br><iframe class="img-frame" src="' + preview + '" allow="autoplay"></iframe>';
    }
  }
  return '<br><img class="q-img" src="' + url + '" alt="image">';
}

function parseSheet(rawText) {
  if (!rawText.trim()) return [];
  const lines = rawText.trim().split('\n').filter(l => l.trim() !== '');
  const questions = [];
  lines.forEach((line, index) => {
    const cols = line.split('\t');
    const q = {
      id: cols[0] || String(index + 1),
      skill: (cols[1] || '').toLowerCase(),
      part: cols[2] || '',
      group: cols[3] || ('G' + (index + 1)),
      type: (cols[4] || 'mcq').toLowerCase(),
      passage: cols[5] || '',
      question: cols[6] || '',
      options: [cols[7] || '', cols[8] || '', cols[9] || '', cols[10] || ''],
      answer: (cols[11] || '').trim()
    };
    questions.push(q);
  });
  return questions;
}

// Passage: text + media
function renderPassageWithMedia(passageText, containerEl, skill) {
  if (!passageText) return;
  const segments = passageText
    .split(' // ')
    .map(s => s.trim())
    .filter(Boolean);
  const textSegments = [];

  segments.forEach(seg => {
    if (/^\[IMG:/i.test(seg)) {
      textSegments.push(seg);
      return;
    }
    const isHttp      = /^https?:\/\//i.test(seg);
    const hasAudioExt = /\.(mp3|wav|m4a|ogg)(\?|$)/i.test(seg);
    const isDriveLink = /drive\.google\.com/i.test(seg);
    const isAudioUrl  = isHttp && hasAudioExt;

    if (isDriveLink || isAudioUrl) {
      if (isDriveLink) {
        let fileId = '';
        const m1 = seg.match(/\/d\/([^\/]+)/);
        const m2 = seg.match(/[?&]id=([^&]+)/);
        if (m1 && m1[1]) fileId = m1[1];
        else if (m2 && m2[1]) fileId = m2[1];
        if (fileId) {
          const iframe = document.createElement('iframe');
          iframe.className = 'audio-frame';
          iframe.src = 'https://drive.google.com/file/d/' + fileId + '/preview';
          iframe.allow = 'autoplay';
          containerEl.appendChild(iframe);
        }
      } else if (isAudioUrl) {
        const audio = document.createElement('audio');
        audio.controls = true;
        audio.src = seg;
        containerEl.appendChild(audio);
      }
    } else {
      textSegments.push(seg);
    }
  });

  if (textSegments.length) {
    const passageDiv = document.createElement('div');
    passageDiv.className = 'passage';
    let html = escapeHtml(textSegments.join(' // '));
    html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/\/\/\s*/g, '<br><br>');
    html = html.replace(/\[IMG:([^\]]+)\]/gi, (m, url) => renderImgToken(url));
    passageDiv.innerHTML = html;
    containerEl.appendChild(passageDiv);
  }
}
  
// Các skill dùng layout 2 cột (trái: đề/ảnh, phải: câu hỏi)
const WIDE_LAYOUT_SKILLS = new Set(['reading', 'math']);

function renderQuiz(questions) {
  const quizDiv = document.getElementById('quiz');
  quizDiv.innerHTML = '';
  const groups = {};
  const groupOrder = [];

  questions.forEach((q, idx) => {
    const key = (q.group && q.group.trim()) ? q.group.trim() : ('G' + q.id);
    if (!groups[key]) {
      groups[key] = { skill: q.skill, passage: q.passage, questions: [] };
      groupOrder.push(key);
    }
    groups[key].questions.push(q);
  });

  let questionCounter = 0;

  groupOrder.forEach(key => {
    const g = groups[key];
    const pTrim = (g.passage || '').trim();


    // READING / MATH: 2 cột (cùng định dạng)
if (WIDE_LAYOUT_SKILLS.has(g.skill)) {

      const layout = document.createElement('div');
      layout.className = 'reading-layout';

      const left = document.createElement('div');
      left.className = 'reading-left group-block';
      const title = document.createElement('h2');
  
     title.textContent = (g.skill === 'math' ? 'Math ' : 'Reading ') + key;

      left.appendChild(title);
      if (pTrim) renderPassageWithMedia(pTrim, left, g.skill);

      const right = document.createElement('div');
      right.className = 'reading-right';

      g.questions.forEach(q => {
        questionCounter++;
        const qDiv = document.createElement('div');
        qDiv.className = 'question';
        qDiv.dataset.answer = (q.answer || '').trim();
        qDiv.dataset.type = q.type || 'short';

        const titleP = document.createElement('p');
        let qHtml = escapeHtml(q.question || '');
        qHtml = qHtml.replace(/\/\/\s*/g, '<br>');
        qHtml = qHtml.replace(/\[IMG:([^\]]+)\]/gi, (m, url) => renderImgToken(url));
        qHtml = qHtml.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        titleP.innerHTML =
          '<span class="question-number">' + questionCounter + '.</span> ' + qHtml;
        qDiv.appendChild(titleP);

        if (q.type === 'mcq') {
          ['A','B','C','D'].forEach((labelOpt, i) => {
            if (!q.options[i]) return;
            const optLabel = document.createElement('label');
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = 'q' + questionCounter;
            radio.value = labelOpt;
            optLabel.appendChild(radio);
            optLabel.appendChild(
              document.createTextNode(' ' + labelOpt + '. ' + q.options[i])
            );
            qDiv.appendChild(optLabel);
            qDiv.appendChild(document.createElement('br'));
          });
        } else {
          const input = document.createElement('input');
          input.type = 'text';
          input.name = 'q' + questionCounter;
          input.className = 'short-answer-input';
          qDiv.appendChild(input);
        }

        right.appendChild(qDiv);
      });

      layout.appendChild(left);
      layout.appendChild(right);
      quizDiv.appendChild(layout);
    } else {
      // LISTENING & khác
      const groupDiv = document.createElement('div');
      groupDiv.className = 'group-block';
      const title = document.createElement('h2');
      title.textContent = (g.skill === 'listening' ? 'Listening ' : 'Section ') + key;
      groupDiv.appendChild(title);
      if (pTrim) renderPassageWithMedia(pTrim, groupDiv, g.skill);

      g.questions.forEach(q => {
        questionCounter++;
        const qDiv = document.createElement('div');
        qDiv.className = 'question';
        qDiv.dataset.answer = (q.answer || '').trim();
        qDiv.dataset.type = q.type || 'short';

        const titleP = document.createElement('p');
        let qHtml = escapeHtml(q.question || '');
        qHtml = qHtml.replace(/\/\/\s*/g, '<br>');
        qHtml = qHtml.replace(/\[IMG:([^\]]+)\]/gi, (m, url) => renderImgToken(url));
        qHtml = qHtml.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        titleP.innerHTML =
          '<span class="question-number">' + questionCounter + '.</span> ' + qHtml;
        qDiv.appendChild(titleP);

        if (q.type === 'mcq') {
          ['A','B','C','D'].forEach((labelOpt, i) => {
            if (!q.options[i]) return;
            const optLabel = document.createElement('label');
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = 'q' + questionCounter;
            radio.value = labelOpt;
            optLabel.appendChild(radio);
            optLabel.appendChild(
              document.createTextNode(' ' + labelOpt + '. ' + q.options[i])
            );
            qDiv.appendChild(optLabel);
            qDiv.appendChild(document.createElement('br'));
          });
        } else {
          const input = document.createElement('input');
          input.type = 'text';
          input.name = 'q' + questionCounter;
          input.className = 'short-answer-input';
          qDiv.appendChild(input);
        }

        groupDiv.appendChild(qDiv);
      });

      quizDiv.appendChild(groupDiv);
    }
  });
}

function normalizeText(str) {
  return (str || '')
    .toLowerCase()
    .replace(/[\u2018\u2019]/g, "'")          // ‘ ’ -> '
    .replace(/[\u00A0\u200B-\u200D\uFEFF]/g, ' ') // xoá khoảng trắng & ký tự ẩn
    .replace(/\s+/g, ' ')                    // gộp nhiều khoảng trắng
    .trim();
}

function gradeQuiz() {
  const quizDiv = document.getElementById('quiz');
  const questionDivs = quizDiv.querySelectorAll('.question');
  let correct = 0;
  const total = questionDivs.length;

  questionDivs.forEach(div => {
    const type = div.dataset.type || 'short';
    const answerRawDisplay = (div.dataset.answer || '').trim();
    const answerList = answerRawDisplay
      .split('|')
      .map(normalizeText)
      .filter(s => s);

    let userAnswer = '';
    if (type === 'mcq') {
      const checked = div.querySelector('input[type="radio"]:checked');
      if (checked) userAnswer = normalizeText(checked.value);
    } else {
      const input = div.querySelector('input[type="text"]');
      if (input) userAnswer = normalizeText(input.value);
    }

    let isCorrect = false;
    if (answerList.length && userAnswer) {
      if (answerList.includes(userAnswer)) isCorrect = true;
    }

    if (isCorrect) {
      div.classList.add('correct');
      div.classList.remove('incorrect');
      correct++;
    } else {
      div.classList.add('incorrect');
      div.classList.remove('correct');
    }
  });

  const percent = Math.round(correct * 100 / Math.max(total, 1));
  const name = (document.getElementById('studentName').value || '').trim() || 'NoName';
  const cls  = (document.getElementById('studentClass').value || '').trim();
  const now  = new Date();
  const timestamp = now.toLocaleString();

  const logLine =
    name + '\t' + cls + '\t' + TEST_ID + '\t' +
    timestamp + '\t' + correct + '\t' + total + '\t' + percent;

  if (LOG_ENDPOINT) {
    const payload = {
      testId:   TEST_ID,
      name:     name,
      className: cls,
      correct:  correct,
      total:    total,
      percent:  percent,
      rawLog:   logLine
    };
    fetch(LOG_ENDPOINT, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }).catch(err => console.error('Error sending result to Sheet:', err));
  }

  const box = document.getElementById('resultBox');
  box.style.display = 'block';
  box.innerHTML = `
  <div style="font-size:16px; margin-bottom:4px;">
    <strong>Bài test:</strong> ${TEST_ID}
  </div>
  <div style="font-size:18px; margin-bottom:8px;">
    <strong>Kết quả:</strong> đúng ${correct}/${total} câu
  </div>
  <div style="
    font-size:28px;
    font-weight:bold;
    color:#007acc;
    padding:10px 0;
  ">
    ${percent}%
  </div>
  `;
}

// Bắt buộc nhập Họ tên & Lớp/Nhóm trước khi nộp
document.getElementById('submitBtn').addEventListener('click', () => {
  const nameInput = document.getElementById('studentName');
  const classInput = document.getElementById('studentClass');
  const name = (nameInput.value || '').trim();
  const cls  = (classInput.value || '').trim();
  if (!name || !cls) {
    alert('Vui lòng nhập đầy đủ HỌ TÊN và LỚP / NHÓM trước khi nộp bài.');
    if (!name) nameInput.focus();
    else if (!cls) classInput.focus();
    return;
  }
  gradeQuiz();
});

document.getElementById('retryBtn').addEventListener('click', () => {
  location.reload();
});

// Khởi động
(function initExam() {
  const qs = parseSheet(RAW_DATA);
  if (!qs.length) {
    document.getElementById('quiz').innerHTML =
      '<p style="color:red;">Giáo viên chưa dán dữ liệu đề vào biến RAW_DATA.</p>';
    return;
  }
  renderQuiz(qs);
  startTimer(DURATION_MINUTES * 60);
})();

loadTestTitle();
</script>

<footer class="footer">
  <p>© <span id="year"></span> Online Practice by Dung Phạm. All rights reserved.</p>
</footer>

<script>
document.getElementById("year").textContent = new Date().getFullYear();
</script>

</body>
</html>
