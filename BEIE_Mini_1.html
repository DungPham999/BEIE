<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Practice Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1100px;
      margin: 20px auto;
      padding: 0 15px;
      line-height: 1.5;
      background-color: #fff7e6;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
    }
    h2 {
      margin-top: 10px;
      margin-bottom: 8px;
      font-size: 18px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 4px;
    }
    .info {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px 12px;
      margin-bottom: 12px;
      background-color: #fafafa;
    }
    .group-block {
      border: 1px solid #eee;
      border-radius: 6px;
      padding: 10px 12px;
      margin-bottom: 15px;
      background-color: #fafafa;
    }
    .passage {
      margin: 8px 0 12px 0;
      padding: 8px 10px;
      border-left: 3px solid #007acc;
      background-color: #ffffff;
      font-size: 14px;
    }
    .question {
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px dashed #ddd;
      background-color: #ffffff;
    }
    .question.correct {
      background-color: #e6ffe6;
    }
    .question.incorrect {
      background-color: #ffe6e6;
    }
    .question-number {
      font-weight: bold;
    }
    .btn {
      padding: 6px 12px;
      margin-right: 8px;
      border-radius: 4px;
      border: 1px solid #888;
      background-color: #f5f5f5;
      cursor: pointer;
      font-size: 14px;
    }
    .btn:hover {
      background-color: #e0e0e0;
    }
    #timer {
      font-weight: bold;
      color: #d9534f;
    }
    .result {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px 12px;
      margin-top: 12px;
      background-color: #fff;
    }
    .short-answer-input {
      width: 70%;
      max-width: 350px;
      padding: 4px;
      font-size: 14px;
    }
    audio {
      width: 100%;
      margin: 8px 0 10px 0;
    }
    iframe.audio-frame {
      width: 100%;
      height: 80px;
      border: 0;
      margin: 8px 0 10px 0;
    }
    img.q-img {
      max-width: 100%;
      height: auto;
      margin: 6px 0;
      display: block;
    }
    .img-frame {
      width: 100%;
      max-width: 100%;
      height: 260px;
      border: 0;
      margin: 6px 0;
      display: block;
    }
    .btn-row {
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
      margin-bottom: 20px;
    }
    .footer {
      text-align: center;
      margin-top: 40px;
      padding: 20px 0;
      color: #444;
      font-size: 14px;
      opacity: 0.85;
    }
    /* Layout hai cột cho Reading */
    .reading-layout {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      margin-bottom: 15px;
    }
    .reading-left {
      flex: 1.4;
    }
    .reading-right {
      flex: 1;
    }
    /* Hiển thị đáp án đúng */
    .correct-answer {
      font-size: 14px;
      font-weight: bold;
      color: #28a745;
      margin-top: 5px;
      padding: 5px;
      background-color: #e1f8e1;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1 id="pageTitle">Đang tải tiêu đề...</h1>

  <div class="info">
    <p><strong>Thời gian làm bài còn lại:</strong> <span id="timer">--:--</span></p>
    <p>Làm xong hãy bấm <strong>Nộp bài</strong> để xem điểm. Có thể tải lại trang để làm lại.</p>
    <p>
      <label>Họ tên học viên:
        <input type="text" id="studentName" placeholder="Nguyễn Văn A">
      </label>
    </p>
    <p>
      <label>Lớp / Nhóm:
        <input type="text" id="studentClass" placeholder="VD: 8A, TOEIC-Reading 1">
      </label>
    </p>
  </div>

  <div id="quiz"></div>

  <div class="btn-row">
    <button class="btn" id="submitBtn">Nộp bài & xem kết quả</button>
    <button class="btn" id="retryBtn">Làm lại từ đầu</button>
  </div>

  <div class="result" id="resultBox" style="display:none;"></div>

  <footer class="footer">
    <p>© <span id="year"></span> Online Practice by Dung Phạm. All rights reserved.</p>
  </footer>

<script>
  // ====== CẤU HÌNH CHUNG ======
  const DURATION_MINUTES = 40;
  // TestID tự động = tên file (không có .html)
  const TEST_ID = location.pathname.split("/").pop().replace(/\.html?$/i, "");
  // Link meta CSV (Level, Title, File, ...)
  const META_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSwmXatD1TfDmC8mB6GBhN_KLZ4mh8NKV_QtuDNVf3dDYNwA2gLvtSVKzb-VRUaP9ILG_vKThvALITu/pub?output=csv";
  // Apps Script nhận log kết quả
  const LOG_ENDPOINT =
    "https://script.google.com/macros/s/AKfycbwv8q--sVh5XrXUS7ZIHCK-VLltJesaT5NmV1cCw1tliN938Rm5iHgWAR_4MeJUmKMh/exec";

  // ====== DỮ LIỆU ĐỀ – DÁN TỪ SHEET VÀO ĐÂY ======
  const RAW_DATA = `
69	reading	Mini 1	Q1-5	short	Questions 1-5. Complete the sentences.// E.g. I’m from Vietnam. I’m Vietnamese.	1.     I’m from France. I’m ____________________.					French
70	reading	Mini 1	Q1-5	short		2.     I’m from Germany. I’m ____________________.					German
71	reading	Mini 1	Q1-5	short		3.     I’m from Sweden. I’m ____________________.					Swedish
72	reading	Mini 1	Q1-5	short		4.     I’m American. I’m from ____________________.					America
73	reading	Mini 1	Q1-5	short		5.     I’m Belgian. I’m from ____________________.					Belgium
74	reading	Mini 1	Q6-15	short	Questions 6-15. Unscramble the words and write the numbers (1-20) in English.	1.     neeevl					eleven
75	reading	Mini 1	Q6-15	short		2.     evif					five
76	reading	Mini 1	Q6-15	short		3.     evtlwe					twelve
77	reading	Mini 1	Q6-15	short		4.     egith					eight
78	reading	Mini 1	Q6-15	short		5.     eevns					seven
79	reading	Mini 1	Q6-15	short		6.     nfetife					fifteen
80	reading	Mini 1	Q6-15	short		7.     ntwyet					twenty 
81	reading	Mini 1	Q6-15	short		8.     inne					nine
82	reading	Mini 1	Q6-15	short		9.     oterfneu					fourteen
83	reading	Mini 1	Q6-15	short		10.  tsxniee					sixteen 
84	reading	Mini 1	Q16-21	short	Questions 16-21. Fill in the gaps with the correct pronoun (I, you, he, she, it) and form of "to be" (am, is, are).	16. I’m from Italy. ____________ Italian.					I am|I’m
85	reading	Mini 1	Q16-21	short		17. Her name is Lisa, and ____________ from Canada.					She is|She’s
86	reading	Mini 1	Q16-21	short		18.  Mike is from Japan. ____________ Japanese.					He is|He’s
87	reading	Mini 1	Q16-21	short		19.  His name is Peter. ____________ from the United States.					He is|He’s
88	reading	Mini 1	Q16-21	short		20.    ____________ a student. I live in London.					I am|I’m
89	reading	Mini 1	Q16-21	short		21.  Her name is Maria. His name is Lucas. ____________ both from Spain.					They are|They’re
90	reading	Mini 1	Q22-26	short	Questions 22-26. Rewrite these sentences into negative and Yes/No question forms. // [IMG: https://drive.google.com/file/d/1qZxC53dYtaEhR0KlCOG0IdYCzlYSQqt_/view?usp=sharing]	a.					It is not hot today.|It isn’t hot today.
91	reading	Mini 1	Q22-26	short		b.					Is it hot today?
92	reading	Mini 1	Q22-26	short		c.					They are not students.|They aren’t students.
93	reading	Mini 1	Q22-26	short		d.					Are they students?
94	reading	Mini 1	Q22-26	short		e.					I am not from Vietnam.|I’m not from Vietnam.
95	reading	Mini 1	Q22-26	short		f.					Are you from Vietnam?
96	reading	Mini 1	Q22-26	short		g.					She is not Russian.|She isn’t Russian.
97	reading	Mini 1	Q22-26	short		h.					Is she Russian?
98	reading	Mini 1	Q22-26	short		i.					He is not my brother.|He isn’t my brother.
99	reading	Mini 1	Q22-26	short		j.					Is he your brother?
100	reading	Mini 1	Q22-26	short	Questions 27-32. Replace the underlined nouns with the appropriate pronouns (he, she, they, it, we, I).	27. This is Emily.  _______ is from Canada.					She
101	reading	Mini 1	Q27-32	short		28.John and Mary are my friends. _______ are nice.					They
102	reading	Mini 1	Q27-32	short		29. There are two apples on the table. _______ are red.					They
103	reading	Mini 1	Q27-32	short		30. My brother's name is Tom. _______ is a student.					He
104	reading	Mini 1	Q27-32	short		31. Sarah and I are classmates. _______ study together.					We
105	reading	Mini 1	Q27-32	short		32.These are my books. _______ are interesting.					They
106	reading	Mini 1	Q27-32	mcq	Questions 33-36. Odd one out.	33.	book	look	seat	cook	c
107	reading	Mini 1	Q33-36	mcq		34.	bed	head	need	seen	c
108	reading	Mini 1	Q33-36	mcq		35.	pen	cheap	bean	seen	a
109	reading	Mini 1	Q33-36	mcq		36.	sheep	ship	sheet	seat	b
110	listening	Mini 1	Q33-36	mcq	https://drive.google.com/file/d/1Fj2_2LdkpHX2S1VpkUY-eTWfy31T_G_-/view?usp=drive_link // Tick the words a) or b) that you hear in the sentences. 	37	sheep	ship			a| He wants a sheep for his birthday.
111	listening	Mini 1	Q37-40	mcq		38	bean	bin			b | That’s a very small bin.
112	listening	Mini 1	Q37-40	mcq		39	men	man			a
113	listening	Mini 1	Q37-40	mcq		40	pull	pool			a 
`;

  // ====== HÀM PHỤ TRỢ ======

  function startTimer(totalSeconds) {
    let timeLeft = totalSeconds;
    const timerEl = document.getElementById('timer');
    let timerInterval = null;

    function updateDisplay() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      timerEl.textContent =
        String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
    }

    updateDisplay();

    timerInterval = setInterval(() => {
      timeLeft--;
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        timeLeft = 0;
        updateDisplay();
        alert('Hết thời gian! Hệ thống sẽ tự chấm điểm.');
        gradeQuiz();
      } else {
        updateDisplay();
      }
    }, 1000);
  }

  function escapeHtml(str) {
    return str
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  // Hiển thị [IMG: url]
  function renderImgToken(urlRaw) {
    const url = urlRaw.trim();

    // Google Drive -> iframe preview
    if (/drive\.google\.com/i.test(url)) {
      let id = '';
      const m1 = url.match(/\/d\/([^\/]+)/);
      const m2 = url.match(/[?&]id=([^&]+)/);
      if (m1 && m1[1]) id = m1[1];
      else if (m2 && m2[1]) id = m2[1];

      if (id) {
        const preview = 'https://drive.google.com/file/d/' + id + '/preview';
        return '<br><iframe class="img-frame" src="' + preview + '" allow="autoplay"></iframe>';
      }
    }
    // Link thường
    return '<br><img class="q-img" src="' + url + '" alt="image">';
  }

  // Parse meta CSV lấy Title
  function parseMetaCSV(text) {
    const lines = text.trim().split("\n");
    if (lines.length < 2) return [];

    const header = lines[0].split(",").map(h => h.trim());
    const rows = lines.slice(1);

    return rows.map(row => {
      const cols = row.split(",");
      const obj = {};
      header.forEach((h, i) => {
        obj[h] = (cols[i] || "").trim();
      });
      return obj;
    });
  }

  async function loadTestTitle() {
    try {
      const resp = await fetch(META_CSV_URL);
      const text = await resp.text();
      const data = parseMetaCSV(text);

      const currentFile = location.pathname.split("/").pop();
      const meta = data.find(r =>
        (r.File || "").toLowerCase() === (currentFile || "").toLowerCase()
      );

      if (meta && meta.Title) {
        document.title = meta.Title;
        const h1 = document.getElementById("pageTitle");
        if (h1) h1.textContent = meta.Title;
      } else {
        const h1 = document.getElementById("pageTitle");
        if (h1 && h1.textContent === "Đang tải tiêu đề...") {
          h1.textContent = "Practice Test";
        }
      }
    } catch (err) {
      console.error("Không đọc được meta CSV:", err);
      const h1 = document.getElementById("pageTitle");
      if (h1 && h1.textContent === "Đang tải tiêu đề...") {
        h1.textContent = "Practice Test";
      }
    }
  }

  // Parse RAW_DATA (tab-separated)
  function parseSheet(rawText) {
    if (!rawText.trim()) return [];
    const lines = rawText.trim().split('\n').filter(l => l.trim() !== '');
    const questions = [];

    lines.forEach((line, index) => {
      const cols = line.split('\t');
      const q = {
        id: cols[0] || String(index + 1),
        skill: (cols[1] || '').toLowerCase(),
        part: cols[2] || '',
        group: cols[3] || ('G' + (index + 1)),
        type: (cols[4] || 'mcq').toLowerCase(),
        passage: cols[5] || '',
        question: cols[6] || '',
        options: [
          cols[7] || '',
          cols[8] || '',
          cols[9] || '',
          cols[10] || ''
        ],
        answer: (cols[11] || '').trim()
      };
      questions.push(q);
    });

    return questions;
  }

  // ====== RENDER ĐỀ ======
  function renderQuiz(questions) {
    const quizDiv = document.getElementById('quiz');
    quizDiv.innerHTML = '';

    const groups = {};
    const groupOrder = [];

    questions.forEach((q, idx) => {
      const key = (q.group && q.group.trim()) ? q.group.trim() : ('G' + q.id);
      if (!groups[key]) {
        groups[key] = {
          skill: q.skill,
          passage: q.passage,
          questions: []
        };
        groupOrder.push(key);
      }
      groups[key].questions.push(q);
    });

    let questionCounter = 0;

    groupOrder.forEach(key => {
      const g = groups[key];
      const pTrim = (g.passage || '').trim();

      // READING: layout 2 cột
      if (g.skill === 'reading') {
        const layout = document.createElement('div');
        layout.className = 'reading-layout';

        const left = document.createElement('div');
        left.className = 'reading-left group-block';

        const title = document.createElement('h2');
        title.textContent = 'Reading ' + key;
        left.appendChild(title);

        if (pTrim) {
          const passageDiv = document.createElement('div');
          passageDiv.className = 'passage';

          let html = escapeHtml(pTrim);
          html = html.replace(/\/\/\s*/g, '<br><br>');
          html = html.replace(/\[IMG:([^\]]+)\]/gi, (m, url) => renderImgToken(url));
          passageDiv.innerHTML = html;

          left.appendChild(passageDiv);
        }

        const right = document.createElement('div');
        right.className = 'reading-right';

        g.questions.forEach(q => {
          questionCounter++;
          const qDiv = document.createElement('div');
          qDiv.className = 'question';
          qDiv.dataset.answer = (q.answer || '').trim();
          qDiv.dataset.type = q.type || 'short';

          const titleP = document.createElement('p');
          let qHtml = escapeHtml(q.question || '');
          qHtml = qHtml.replace(/\/\/\s*/g, '<br>');
          qHtml = qHtml.replace(/\[IMG:([^\]]+)\]/gi, (m, url) => renderImgToken(url));

          titleP.innerHTML =
            '<span class="question-number">' + questionCounter + '.</span> ' + qHtml;
          qDiv.appendChild(titleP);

          if (q.type === 'mcq') {
            ['A','B','C','D'].forEach((labelOpt, i) => {
              if (!q.options[i]) return;
              const optLabel = document.createElement('label');
              const radio = document.createElement('input');
              radio.type = 'radio';
              radio.name = 'q' + questionCounter;
              radio.value = labelOpt;
              optLabel.appendChild(radio);
              optLabel.appendChild(
                document.createTextNode(' ' + labelOpt + '. ' + q.options[i])
              );
              qDiv.appendChild(optLabel);
              qDiv.appendChild(document.createElement('br'));
            });
          } else {
            const input = document.createElement('input');
            input.type = 'text';
            input.name = 'q' + questionCounter;
            input.className = 'short-answer-input';
            qDiv.appendChild(input);
          }

          right.appendChild(qDiv);
        });

        layout.appendChild(left);
        layout.appendChild(right);
        quizDiv.appendChild(layout);

      } else {
        // LISTENING & KHÁC: layout dọc
        const groupDiv = document.createElement('div');
        groupDiv.className = 'group-block';

        const title = document.createElement('h2');
        title.textContent = (g.skill === 'listening' ? 'Listening ' : 'Section ') + key;
        groupDiv.appendChild(title);

        if (pTrim) {
          let mediaPart = pTrim;
          let textPart = '';

          const sepIndex = pTrim.indexOf(' // ');
          if (sepIndex !== -1) {
            mediaPart = pTrim.slice(0, sepIndex).trim();
            textPart = pTrim.slice(sepIndex + 4).trim();
          }

          const isHttp = /^https?:\/\//i.test(mediaPart);
          const hasAudioExt = /\.(mp3|wav|m4a|ogg)(\?|$)/i.test(mediaPart);
          const isDriveLink = /drive\.google\.com/i.test(mediaPart);
          const isAudioUrl = isHttp && hasAudioExt;

          if (g.skill === 'listening' && isDriveLink) {
            let fileId = '';
            const m1 = mediaPart.match(/\/d\/([^\/]+)/);
            const m2 = mediaPart.match(/[?&]id=([^&]+)/);
            if (m1 && m1[1]) fileId = m1[1];
            else if (m2 && m2[1]) fileId = m2[1];

            if (fileId) {
              const iframe = document.createElement('iframe');
              iframe.className = 'audio-frame';
              iframe.src = 'https://drive.google.com/file/d/' + fileId + '/preview';
              iframe.allow = 'autoplay';
              groupDiv.appendChild(iframe);
            }
          } else if (g.skill === 'listening' && isAudioUrl) {
            const audio = document.createElement('audio');
            audio.controls = true;
            audio.src = mediaPart;
            groupDiv.appendChild(audio);
          }

          if (textPart) {
            const passageDiv = document.createElement('div');
            passageDiv.className = 'passage';
            let html = escapeHtml(textPart);
            html = html.replace(/\/\/\s*/g, '<br><br>');
            html = html.replace(/\[IMG:([^\]]+)\]/gi, (m, url) => renderImgToken(url));
            passageDiv.innerHTML = html;
            groupDiv.appendChild(passageDiv);
          }
        }

        g.questions.forEach(q => {
          questionCounter++;
          const qDiv = document.createElement('div');
          qDiv.className = 'question';
          qDiv.dataset.answer = (q.answer || '').trim();
          qDiv.dataset.type = q.type || 'short';

          const titleP = document.createElement('p');
          let qHtml = escapeHtml(q.question || '');
          qHtml = qHtml.replace(/\/\/\s*/g, '<br>');
          qHtml = qHtml.replace(/\[IMG:([^\]]+)\]/gi, (m, url) => renderImgToken(url));

          titleP.innerHTML =
            '<span class="question-number">' + questionCounter + '.</span> ' + qHtml;
          qDiv.appendChild(titleP);

          if (q.type === 'mcq') {
            ['A','B','C','D'].forEach((labelOpt, i) => {
              if (!q.options[i]) return;
              const optLabel = document.createElement('label');
              const radio = document.createElement('input');
              radio.type = 'radio';
              radio.name = 'q' + questionCounter;
              radio.value = labelOpt;
              optLabel.appendChild(radio);
              optLabel.appendChild(
                document.createTextNode(' ' + labelOpt + '. ' + q.options[i])
              );
              qDiv.appendChild(optLabel);
              qDiv.appendChild(document.createElement('br'));
            });
          } else {
            const input = document.createElement('input');
            input.type = 'text';
            input.name = 'q' + questionCounter;
            input.className = 'short-answer-input';
            qDiv.appendChild(input);
          }

          groupDiv.appendChild(qDiv);
        });

        quizDiv.appendChild(groupDiv);
      }
    });
  }

 function gradeQuiz() {
  const quizDiv = document.getElementById('quiz');
  const questionDivs = quizDiv.querySelectorAll('.question');
  let correct = 0;
  const total = questionDivs.length;

  questionDivs.forEach(div => {
    const type = div.dataset.type || 'short';

    // Lấy đáp án gốc (nguyên văn, để hiển thị)
    const answerRawDisplay = (div.dataset.answer || '').trim();

    // Chuẩn hóa đáp án để so sánh (lowercase)
    const answerRaw = answerRawDisplay.toLowerCase();

    // Tách thành nhiều đáp án bằng | / ;  (vd: "airport|the airport")
    const answerList = answerRaw
      .split(/[\|;/]+/)
      .map(a => a.trim())
      .filter(a => a);

    let userAnswer = '';

    if (type === 'mcq') {
      const checked = div.querySelector('input[type="radio"]:checked');
      if (checked) {
        userAnswer = checked.value.trim().toLowerCase();
      }
    } else {
      const input = div.querySelector('input[type="text"]');
      if (input) {
        userAnswer = input.value.trim().toLowerCase();
      }
    }

    // So sánh: đúng nếu userAnswer trùng BẤT KỲ phần tử nào trong answerList
    let isCorrect = false;
    if (answerList.length && userAnswer) {
      if (type === 'mcq') {
        // MCQ thì thường chỉ có 1 đáp án, nhưng vẫn cho phép nhiều (A|B...)
        isCorrect = answerList.includes(userAnswer);
      } else {
        // Short answer
        isCorrect = answerList.includes(userAnswer);
      }
    }

    if (isCorrect) {
      div.classList.add('correct');
      div.classList.remove('incorrect');
      correct++;
    } else {
      div.classList.add('incorrect');
      div.classList.remove('correct');
    }

    // ----- HIỆN ĐÁP ÁN ĐÚNG -----
    // Nếu đã có <div class="correct-answer"> thì không tạo thêm
    let correctAnswerDiv = div.querySelector('.correct-answer');
    if (!correctAnswerDiv) {
      correctAnswerDiv = document.createElement('div');
      correctAnswerDiv.className = 'correct-answer';

      // Hiển thị đẹp: thay | / ; bằng " / "
      const displayText = answerRawDisplay.replace(/[\|;/]+/g, ' / ');
      correctAnswerDiv.textContent = 'Đáp án đúng: ' + displayText;
      div.appendChild(correctAnswerDiv);
    }

    // ----- KHÓA CÁC Ô TRẢ LỜI -----
    const inputs = div.querySelectorAll('input');
    inputs.forEach(input => {
      input.disabled = true;
    });
  });

  // Tính % điểm
  const percent = Math.round(correct * 100 / Math.max(total, 1));

  const name = (document.getElementById('studentName').value || '').trim() || 'NoName';
  const cls  = (document.getElementById('studentClass').value || '').trim();
  const now  = new Date();
  const timestamp = now.toLocaleString();  // giờ & ngày hiện tại

  // Dòng báo cáo dạng TSV (tab-separated) để dán vào Google Sheet
  const logLine =
    name + '\t' +
    cls + '\t' +
    TEST_ID + '\t' +
    timestamp + '\t' +
    correct + '\t' +
    total + '\t' +
    percent;

  // Gửi kết quả lên Google Sheet (LOG_ENDPOINT đã cấu hình phía trên)
  if (typeof LOG_ENDPOINT !== 'undefined' && LOG_ENDPOINT) {
    const payload = {
      testId:   TEST_ID,
      name:     name,
      className: cls,
      correct:  correct,
      total:    total,
      percent:  percent,
      rawLog:   logLine
    };

    fetch(LOG_ENDPOINT, {
      method: 'POST',
      mode: 'no-cors',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    }).catch(err => {
      console.error('Error sending result to Sheet:', err);
    });
  }

  // Hiển thị box kết quả
  const box = document.getElementById('resultBox');
  box.style.display = 'block';
  box.innerHTML = `
    <div style="font-size:18px; margin-bottom:8px;">
      <strong>Kết quả:</strong> đúng ${correct}/${total} câu
    </div>
    <div style="
      font-size:28px;
      font-weight:bold;
      color:#007acc;
      padding:10px 0;
    ">
      ${percent}%
    </div>
  `;

  // ----- KHÓA NÚT NỘP BÀI, MỞ NÚT LÀM LẠI -----
  const submitBtn = document.getElementById('submitBtn');
  if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.textContent = 'Đã nộp bài';
  }

  const retryBtn = document.getElementById('retryBtn');
  if (retryBtn) {
    retryBtn.disabled = false;
    retryBtn.textContent = 'Làm lại từ đầu';
  }
}


  // ====== GẮN SỰ KIỆN ======
  document.getElementById('submitBtn').addEventListener('click', gradeQuiz);
  document.getElementById('retryBtn').addEventListener('click', () => {
    location.reload();
  });

  // ====== KHỞI ĐỘNG ======
  (function initExam() {
    const qs = parseSheet(RAW_DATA);
    if (!qs.length) {
      document.getElementById('quiz').innerHTML =
        '<p style="color:red;">Giáo viên chưa dán dữ liệu đề vào biến RAW_DATA.</p>';
      return;
    }
    renderQuiz(qs);
    startTimer(DURATION_MINUTES * 60);
  })();

  // Cập nhật năm footer
  document.getElementById("year").textContent = new Date().getFullYear();

  // Lấy title từ Google Sheet
  loadTestTitle();
</script>
</body>
</html>
