<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Vocabulary Quiz</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 20px auto;
      padding: 0 16px;
      background-color: #fff7e6;
      line-height: 1.5;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
    }
    .info {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px 12px;
      margin-bottom: 12px;
      background-color: #fafafa;
    }
    .info p { margin: 4px 0; }
    #timer {
      font-weight: bold;
      color: #d9534f;
    }
    .quiz-box {
      border: 1px solid #eee;
      border-radius: 6px;
      padding: 14px 16px;
      background: #ffffff;
      margin-bottom: 16px;
    }
    .vn-text {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .audio-wrapper {
      margin: 8px 0 12px 0;
    }
    audio {
      width: 100%;
    }
  
    .audio-frame {
  width: 100%;
  height: 80px;        /* có thể tăng/giảm */
  border: 0;
  margin: 8px 0 10px 0;
}

    
    .answer-wrapper {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    #answerInput {
      flex: 1;
      min-width: 180px;
      padding: 6px 8px;
      font-size: 16px;
    }
    .btn {
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid #888;
      background-color: #f5f5f5;
      cursor: pointer;
      font-size: 14px;
    }
    .btn:hover { background-color: #e0e0e0; }
    .btn:disabled {
      opacity: 0.6;
      cursor: default;
    }
    #feedback {
      margin-top: 10px;
      font-size: 15px;
      padding: 6px 8px;
      border-radius: 4px;
    }
    #feedback.ok {
      background-color: #e6ffe6;
      color: #155724;
      border: 1px solid #b7e0b7;
    }
    #feedback.ng {
      background-color: #ffe6e6;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status-line {
      margin-top: 8px;
      font-size: 14px;
    }
    .result-box {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px 14px;
      background: #fff;
      display: none;
    }
    .result-main {
      font-size: 24px;
      font-weight: bold;
      color: #007acc;
      margin: 6px 0;
    }
    .footer {
      text-align: center;
      margin-top: 30px;
      padding: 16px 0;
      color: #444;
      font-size: 13px;
      opacity: 0.85;
    }

    /* ===== TỐI ƯU CHO MÀN HÌNH NHỎ (ĐIỆN THOẠI) ===== */
@media (max-width: 600px) {
  body {
    max-width: 100%;
    margin: 0;
    padding: 8px 10px;
    font-size: 16px;         /* chữ to hơn một chút */
  }

  h1 {
    font-size: 22px;
    margin: 12px 0;
    text-align: center;
  }

  .info {
    padding: 10px;
  }

  .info label {
    display: block;
    margin-bottom: 6px;
  }

  .info input {
    width: 100%;             /* ô nhập Họ tên / Lớp full chiều ngang */
    box-sizing: border-box;
    margin-top: 3px;
    padding: 8px 10px;
    font-size: 16px;
  }

  .quiz-box {
    padding: 10px 10px;
  }

  .vn-text {
    font-size: 18px;
  }

  .audio-frame {
    height: 100px;           /* to hơn chút cho dễ bấm nút play */
  }

  .answer-wrapper {
    flex-direction: column;  /* input và nút xếp theo cột */
    align-items: stretch;
    gap: 6px;
  }

  #answerInput {
    font-size: 18px;
    padding: 10px 12px;
  }

  .btn {
    font-size: 16px;
    padding: 10px 14px;
    width: 100%;             /* nút rộng cả dòng, dễ bấm */
    text-align: center;
  }

  .status-line {
    font-size: 14px;
  }

  #feedback {
    font-size: 14px;
  }

  .result-main {
    font-size: 20px;
  }
}

    
  </style>
</head>
<body>
  <h1 id="title"></h1>


  <div class="info">
    <p><strong>Thời gian làm bài:</strong> <span id="timer">00:00</span></p>

    <p><strong>Mục tiêu:</strong> làm đúng <span id="targetCorrectText">--</span> câu để hoàn thành.</p>
    <p>
      <label>Họ tên học viên:
        <input type="text" id="studentName" placeholder="Nguyễn Văn A" />
      </label>
    </p>
    <p>
      <label>Lớp / Nhóm:
        <input type="text" id="studentClass" placeholder="VD: TOEIC Reading 1" />
      </label>
    </p>
  </div>

  <div class="quiz-box" id="quizBox">
    <div class="status-line">
      Câu đúng: <span id="correctCount">0</span> /
      Câu đã làm: <span id="totalDone">0</span>
    </div>
    <hr />

    <div class="vn-text" id="vnText">Đang tải câu hỏi...</div>

    <div class="audio-wrapper">
     
      <!-- Dùng iframe giống IELTS -->
<iframe
  id="audioFrame"
  class="audio-frame"
  allow="autoplay">
</iframe>

      
    </div>

    <div class="answer-wrapper">
      <input
        type="text"
        id="answerInput"
        placeholder="Gõ đáp án tiếng Anh..."
        autocomplete="off"
      />
      <button class="btn" id="checkBtn">Check</button>
      <button class="btn" id="nextBtn" style="display:none;">Câu tiếp</button>
    </div>

    <div id="feedback"></div>
  </div>

  <div class="result-box" id="resultBox">
    <div><strong>Kết quả bài làm:</strong></div>
    <div class="result-main" id="resultScore"></div>
    <div id="resultDetail"></div>
  </div>

  <div class="footer">
    © <span id="year"></span> Online Practice by Dung Phạm. All rights reserved.
  </div>

<script>
  // ========= CẤU HÌNH =========
// Tự lấy tên file hiện tại làm TestID (đã giải mã %20 -> khoảng trắng)
const fileSegment = location.pathname.split('/').pop() || '';
const TEST_ID = decodeURIComponent(
  fileSegment.replace(/\.[^/.]+$/, '')   // bỏ .html, .htm...
) || 'DefaultTest';



  const TARGET_CORRECT = 30;          // số câu cần đúng để kết thúc
  const TIME_LIMIT_MINUTES = 20;      // thời gian tối đa (phút)
  const LOG_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwv8q--sVh5XrXUS7ZIHCK-VLltJesaT5NmV1cCw1tliN938Rm5iHgWAR_4MeJUmKMh/exec';
    // Mỗi lần mở trang -> 1 attemptId riêng
  const ATTEMPT_ID = Date.now().toString(36) + '-' + Math.random().toString(36).slice(2, 8);

  // ========= NGÂN HÀNG CÂU HỎI =========
  // Copy 4 cột: ID | VN | Answer | Audio (KHÔNG lấy dòng tiêu đề)
  // từ Google Sheets và dán vào giữa cặp ` ... ` dưới đây.
  const RAW_DATA = `

314	ưu đãi đặc biệt	a special discount	https://drive.google.com/file/d/1OqDf_SYrHSrx222IMPMBn-uBWnbBwfi0/view?usp=drivesdk
315	điều đó nghĩa là tiết kiệm	it means savings	https://drive.google.com/file/d/1TqOpRVWIQDr30QmaFUHsUo6s6H-8GaJ6/view?usp=drivesdk
316	tranh phong cảnh	landscape paintings	https://drive.google.com/file/d/19Qjcvv9v2dZqITcdUb6rFkVVS601isBt/view?usp=drivesdk
317	tranh chân dung	portrait paintings	https://drive.google.com/file/d/1WC6sIEBsxyOJDMQC_jlLhaMRU43EpqRU/view?usp=drivesdk
318	tranh tĩnh vật	still-life paintings	https://drive.google.com/file/d/1AwyqZ8pLLysXciHnzu3WDitjJqt3xvUc/view?usp=drivesdk
319	tranh cổ điển	classical paintings	https://drive.google.com/file/d/1UIVGnwlBrEN6WHW16R5mqPxXeYMp_WVW/view?usp=drivesdk
320	tranh lập thể	cubist paintings	https://drive.google.com/file/d/1eiqiPfaQ4O4wVpGGnp_vwH4GG9Bi-0S0/view?usp=drivesdk
321	lớp vẽ cho mọi trình độ	painting classes for all levels	https://drive.google.com/file/d/1zI7Pw0eivUt5sQnp_AZghzsS9_76Wp7f/view?usp=drivesdk
322	từ người mới đến chuyên gia	from novices through experts	https://drive.google.com/file/d/1PDT1fkF5RAqf9U92hTOgnoq65Sm1MOS8/view?usp=drivesdk
323	tham gia cùng chúng tôi	to join us	https://drive.google.com/file/d/1Wwkling4deXvhJjtBeAcXN-Ny1KGqmAX/view?usp=drivesdk
324	tìm hiểu điều mọi người đang nói đến	to find out what everyone is talking about	https://drive.google.com/file/d/1H9mloUGLVkoNSB3sKLY2ve7DwvA3mgX0/view?usp=drivesdk
325	ưu đãi này không áp dụng cho tranh màu nước	The offer does not apply to watercolors	https://drive.google.com/file/d/1ZR2y-uofaLj6zAU3NFoJ_I7HYJgCkH-f/view?usp=drivesdk
326	kỳ nghỉ biển mùa đông	a winter beach vacation	https://drive.google.com/file/d/1hEsbU_9JMXSz6BHygJbbGPY0STTISC4a/view?usp=drivesdk
327	tiết kiệm lên đến	to save up to	https://drive.google.com/file/d/10T3lv_qX63CKVlTy1IseYYpVrNTMGlgb/view?usp=drivesdk
328	lên kế hoạch kỳ nghỉ mùa đông	to plan your winter escape	https://drive.google.com/file/d/1G2n9DeRiEpqZYcFDFMLao_KSN9yN-uQw/view?usp=drivesdk
329	điểm đến ngập tràn nắng	sun-drenched destinations	https://drive.google.com/file/d/1sAm1eksUsInucO3V2X3C_muRskZKPnY8/view?usp=drivesdk
330	đầy đủ loại khách sạn	a full range of hotels	https://drive.google.com/file/d/1gUJhD5EImEB13GzAEAifgHPgHqNc21K2/view?usp=drivesdk
331	phù hợp mọi ngân sách	to fit all budgets	https://drive.google.com/file/d/10GiM6DiUA6yIhn_cvICIHFSfUGTff3Od/view?usp=drivesdk
332	ngân sách từ thấp đến cao	from shoestring to champagne	https://drive.google.com/file/d/1-eZbYKc8c8MUmFy_RNqiDS8czWLvYDuk/view?usp=drivesdk
333	lưu trú tại khu nghỉ dưỡng	to stay at a resort	https://drive.google.com/file/d/1vado0wW443qnKKBDR_D3FqMyGppYRHzH/view?usp=drivesdk
334	bảo đảm mức giá thấp nhất	to guarantee the lowest prices	https://drive.google.com/file/d/1I0ETRfBCrNd0A5B9E6WFV6s0Q8OYYEzn/view?usp=drivesdk
335	hoàn tiền nếu giá giảm	a refund if prices go down	https://drive.google.com/file/d/1JUvZiyohvYKBnLYFXlek-t6EX4S2sUgK/view?usp=drivesdk
336	kỳ nghỉ tuyệt nhất	the best vacation ever	https://drive.google.com/file/d/1litmq8Lodec0ctPKOEOpc-A5NMvcEwkd/view?usp=drivesdk
337	phí khách sạn, thuế và tiền tip	hotel fees, taxes, and gratuities	https://drive.google.com/file/d/1B1AZ6GrlnsH-AIKxegOBrEygjdvi3-nA/view?usp=drivesdk
338	không bao gồm	be not included	https://drive.google.com/file/d/1vpopYpkye_g_rgv3ma3fH4czpaawv-zt/view?usp=drivesdk
339	giấy phép đỗ xe	a parking permit	https://drive.google.com/file/d/1LEd2iM3XuczaD2G65WD93mhpPAZH0Ipq/view?usp=drivesdk
340	trạm vào cửa	the entrance station	https://drive.google.com/file/d/1b2iCY_eLOLvDiWc-fDFtpyxt1oWQ_pcD/view?usp=drivesdk
341	sự thay thế / vật thay thế	a replacement	https://drive.google.com/file/d/1w0c2QbSuWpmgTrUrASbcuMUXb6ueKQ41/view?usp=drivesdk
342	thông báo	a notification	https://drive.google.com/file/d/1dmji5HIfCMM6AEgt51I75xHUX7XuIH0V/view?usp=drivesdk
343	việc phân giao nhiệm vụ	the delegation of tasks	https://drive.google.com/file/d/1bcoEvAw5ForS7Ew5q2GvPQCP9RWI04Ap/view?usp=drivesdk
344	đạt được thỏa thuận	to reach an agreement	https://drive.google.com/file/d/1YxEkUPaRKDssHjAiMdVqfJwSN4sdBU2L/view?usp=drivesdk
345	bộ nhiều màu sắc đa dạng	an assortment of colors	https://drive.google.com/file/d/1qXcUEozq9c1-t2gN5iUL0QRhu0OLxCUm/view?usp=drivesdk
346	tỷ lệ người có việc làm tăng	the rising employment rate	https://drive.google.com/file/d/1MOIvYm5wSyN0YvhnN_gFSeF4ujtU2liB/view?usp=drivesdk
347	sự gia tăng trong việc xây dựng nhà ở	the growth in the housing construction site	https://drive.google.com/file/d/1HncmOyZmTkDhVWp9NLQWSFTUsTstrl65/view?usp=drivesdk
348	tiềm năng sinh lợi	the potential profitability	https://drive.google.com/file/d/1Sejm8cvX4v3b0ASRPg2LPfwhwAPVxVFa/view?usp=drivesdk
349	khiếu hài hước	a sense of humor	https://drive.google.com/file/d/1LAhs2ReLuChhiQmoiKfy2mQ1YSQi-Vp_/view?usp=drivesdk
350	hợp đồng	the contract	https://drive.google.com/file/d/1o69_k2v6rwodxhbyV74sey4E6xeI8V22/view?usp=drivesdk
351	quy định về đỗ xe	parking regulations	https://drive.google.com/file/d/12jglKRp4fNd-fuZPI1rsA69iEJ2Vkd9M/view?usp=drivesdk
352	sự phê duyệt	an approval	https://drive.google.com/file/d/1KX6M8UixZpYBvrPkElHbMAqjGVENfllh/view?usp=drivesdk
353	vị trí tuyển dụng	a job opening	https://drive.google.com/file/d/1RkQvMUkf16j6eL11-Yw8t0x6p_vSqCZN/view?usp=drivesdk
354	dịch vụ khách hàng	customer service	https://drive.google.com/file/d/17K0licYFNYVtr43KrVmHgVhDRYYKlYHl/view?usp=drivesdk
355	tiệc chia tay	a farewell party	https://drive.google.com/file/d/1C1eL-LxFcQKQ2J6QDhs4BbNeFFWnVL5N/view?usp=drivesdk
356	phỏng vấn xin việc	a job interview	https://drive.google.com/file/d/1Od7XlMhoOti_iT4rxkplBD3aJEsrA9pn/view?usp=drivesdk
357	tài khoản ngân hàng	a bank account	https://drive.google.com/file/d/1vY1KqzCNJrbXP9F46-07A55Za_s4fqlV/view?usp=drivesdk
358	số liệu doanh số	sales figures	https://drive.google.com/file/d/1XeI2crgHGJEAJrRyblEotbMNSKzADXmn/view?usp=drivesdk
359	mẫu đơn xin	an application form	https://drive.google.com/file/d/1mThp0VNMSgMoCaAMTf-caRCSz-8RxlBW/view?usp=drivesdk
360	quy tắc an toàn	safety rules	https://drive.google.com/file/d/1zDAO4otWdAkl5mvZPbuRvoHCDIEpMQy4/view?usp=drivesdk
361	phí vào cửa	an admission fee	https://drive.google.com/file/d/118DqCLaK4fjzVPqf3dFh7UJnXIbcVfta/view?usp=drivesdk
362	lãi suất	an interest rate	https://drive.google.com/file/d/1blRrD3yrtiOCdcveidQXKjxIrV7csXHx/view?usp=drivesdk
363	phí bảo trì	the maintenance fee	https://drive.google.com/file/d/1GEtqgPjy9uv1efXxIe0fbBP6MUTdGvmN/view?usp=drivesdk
364	nhân viên kinh doanh	a sales representative	https://drive.google.com/file/d/12vVYdfgXnR7P9yxAu_iGBgm6qHGVCJ3x/view?usp=drivesdk
365	các khiếu nại của khách hàng	customer complaints	https://drive.google.com/file/d/1gjH72GxvhaD0-0-wBZ5deLlHpHtqXSic/view?usp=drivesdk
366	những đánh giá sản phẩm	product reviews	https://drive.google.com/file/d/1kS1dFjDp7vf7h1urwyJ97Xz6f7a-4aFm/view?usp=drivesdk
367	địa chỉ giao hàng	the shipping address	https://drive.google.com/file/d/1Z8LbhcE-YbxjIufU-MOQzPYy30XmelBV/view?usp=drivesdk
368	ngày hết hạn	an expiration date	https://drive.google.com/file/d/1cCKAPTKVmjnc144XLxLUWc_vXxItTWUm/view?usp=drivesdk
369	phiếu giảm giá	a discount coupon	https://drive.google.com/file/d/1hdnPILXlU_YaVrWVMvxDplkE4tDQ6juH/view?usp=drivesdk
370	kinh nghiệm làm việc ở nước ngoài	overseas experience	https://drive.google.com/file/d/1loYbbiD3zhS3k3nyhQwceAmZ1f1LDL4r/view?usp=drivesdk
371	bằng cấp, năng lực mà ứng cử viên cần có	the main qualification	https://drive.google.com/file/d/1IhQXqQWCgWtYBetY9gPwv0BThYp4FT_t/view?usp=drivesdk
372	vị trí (công việc)	the position	https://drive.google.com/file/d/1arE24vtcpb2pLOej-vkf-qYIggtHIyYS/view?usp=drivesdk
373	nhân viên kinh doanh	sales representatives	https://drive.google.com/file/d/1H_lqZjv1Of93eEChJtWqtSlNqQqn3pvm/view?usp=drivesdk
374	thông tin chi tiết	detailed information	https://drive.google.com/file/d/1lXkyMYiFoF3a-eqYlL5fRmbWEcv1sk2s/view?usp=drivesdk
375	năng suất thấp	low productivity	https://drive.google.com/file/d/1Yxq9uQgxTXWq8PoKzghLKk8-i8NzXL1h/view?usp=drivesdk
376	được giao đến nhà bạn	be delivered to your house	https://drive.google.com/file/d/1ao3___BpdeATdxyYL8Vmnx_mzbwIqhYM/view?usp=drivesdk
377	sự tham gia tích cực của bạn	your active participation	https://drive.google.com/file/d/1WCOqde9dcjRa_3PoNKPZUGzuaANZ6RjK/view?usp=drivesdk
378	sự cho phép của quản lý của anh ấy	his manager’s permission	https://drive.google.com/file/d/1YOVrGO5_uIQr8RNSB0rOXnk94cSj3WJR/view?usp=drivesdk
379	doanh thu năm ngoái	last year’s turnover	https://drive.google.com/file/d/10oedCrUqQSRdQQaAfsJmf9MDsSD6Xf9r/view?usp=drivesdk
380	các điều kiện thị trường	the market conditions	https://drive.google.com/file/d/1XcUNM2FBh3bX52E0DyjGXwOpKBelLBoA/view?usp=drivesdk
381	lễ khai trương	the grand opening	https://drive.google.com/file/d/1sXNKk81UjiCesJtcAQFdRTC_070eBtQ1/view?usp=drivesdk
382	giám sát viên	supervisors	https://drive.google.com/file/d/1UtSb5Lw13Q8Ki8iWOgL0xKmO3DjUN7TZ/view?usp=drivesdk
383	một trong hai người tham gia	either of the participants	https://drive.google.com/file/d/1_7uYKBwhJtTa-3qpHf0qt-rig-wuikZu/view?usp=drivesdk
384	các buổi đào tạo	training sessions	https://drive.google.com/file/d/15KAm7GbvTm8WzxN1QaorNizrFPI_TtqS/view?usp=drivesdk
385	quy định an toàn	safety regulations	https://drive.google.com/file/d/1foWBngef4VQe9t0_IrLRj8GcOuYQqDJt/view?usp=drivesdk
386	thiết bị phù hợp	the right equipment	https://drive.google.com/file/d/1Ol1k-KpJiPJ9csprTZnRheqoz5-cXluE/view?usp=drivesdk
387	sự sáng tạo không thể so sánh	incomparable creativity	https://drive.google.com/file/d/1lwKS0BQt1A0D7phmtnJXv1ERCHK2fNzj/view?usp=drivesdk
388	ý tưởng xuất sắc	brilliant ideas	https://drive.google.com/file/d/1CmAgYb1mWLeU9Rl6l5zoMEg1UHDO3dCo/view?usp=drivesdk
389	báo cáo mới nhất	the latest report	https://drive.google.com/file/d/1RUIBGBeUeikBIw-H5cgi8GpgWBdex8s-/view?usp=drivesdk
390	giấy phép lao động	a work permit	https://drive.google.com/file/d/1iuJobuaE888e1wN4Whoo8IE2cwE8Pvk0/view?usp=drivesdk
391	bằng tiến sĩ	a doctoral degree	https://drive.google.com/file/d/1wWk2uhCbx8qzf7mvF16DbUTfXd43-az3/view?usp=drivesdk
392	phát triển sự nghiệp	career development	https://drive.google.com/file/d/1MM9bt2nc7Vz7R9V6OU7qAt_egUKmYblN/view?usp=drivesdk
393	mức lương cạnh tranh	a competitive salary	https://drive.google.com/file/d/1BaD2bKjffCg4N8Y2302QI5hEH6vr9bux/view?usp=drivesdk
394	phúc lợi xã hội	social benefits	https://drive.google.com/file/d/15LfRgkwfdn017KpDRMMs-1tLX4jrLU3A/view?usp=drivesdk
395	nhà nghiên cứu cấp cao	a senior researcher	https://drive.google.com/file/d/1brKv1HvFQQuhXLaxYqO6xYiLspMAT2uy/view?usp=drivesdk
396	phát triển mỹ phẩm	cosmetics development	https://drive.google.com/file/d/1-ACtxZiR9xZgQUoCQp-tSo16_iBjcFUM/view?usp=drivesdk
397	bằng tiến sĩ trong lĩnh vực liên quan	a doctoral degree in the related field	https://drive.google.com/file/d/1MOitbp6nlp0o-ajFbhyCkKA_fVPb9W_U/view?usp=drivesdk
398	kỹ năng giao tiếp xuất sắc	excellent communication skills	https://drive.google.com/file/d/1A3CSgQ8iiDY3aIPuDSAwxxTys9qIYCch/view?usp=drivesdk
399	kỹ năng thuyết trình xuất sắc	excellent presentation skills	https://drive.google.com/file/d/1tp13ms8gp0C35BL6ctjHH92KYvhGd3hX/view?usp=drivesdk
400	môi trường làm việc tốt	a good work environment	https://drive.google.com/file/d/1d6Zij-7K7fJky9189Foh0eo3w_pL9sLq/view?usp=drivesdk
401	nhiều cơ hội	abundant opportunities	https://drive.google.com/file/d/149uLT_7viMYT6jEmHkR5ljngIu3Yq2YZ/view?usp=drivesdk
402	cơ hội phát triển sự nghiệp	career development opportunities	https://drive.google.com/file/d/1VCDXrC5t8vbhurlRIaGy3yGsXw6AiHqQ/view?usp=drivesdk
403	cân nhắc một phương án thay thế	to consider an alternative	https://drive.google.com/file/d/11gHHmUUxM9R4m7SYw-ZuHcWWJSWeYczW/view?usp=drivesdk
404	thời gian lễ hội diễn ra	the duration of the festival	https://drive.google.com/file/d/15xT2Rfr0E9N2IppshMqkK-jFOpiVVunI/view?usp=drivesdk
405	hạn nộp báo cáo doanh số	a deadline for a sales report	https://drive.google.com/file/d/175qA5zPdUBZeO0-JIQDWNjduz9ZqIRDb/view?usp=drivesdk
406	một phương tiện di chuyển	a means of transportation	https://drive.google.com/file/d/12JArE-4TnrrACtTOYNBK29kPgwScs0Iw/view?usp=drivesdk
407	sở thích ăn uống của bạn	your preference for food	https://drive.google.com/file/d/1ECSbGtA1rxAQT0uEZzyBg8VJCfrtba-K/view?usp=drivesdk
408	các khoản chi phí đi lại	travel expenses	https://drive.google.com/file/d/1ox_Bre5dLG-ZBC31TXqnj-xBbuTEeU2Y/view?usp=drivesdk
409	thực hiện biện pháp an toàn	to take safety measures	https://drive.google.com/file/d/1lpJfsHUe4EHsNnf56-v3puzGUzNBv5nk/view?usp=drivesdk
410	cải thiện bảo trì cơ sở vật chất	to improve facility maintenance	https://drive.google.com/file/d/1x9ERLCvjF11JtzD8HBmTv2GgIoms25VH/view?usp=drivesdk
411	đi đến kết luận vội vàng	to come to a hasty conclusion	https://drive.google.com/file/d/1pckUBDlh4o__7tPdkSWQ0vNJBfbXehih/view?usp=drivesdk
412	đạt được thỏa thuận chung	to reach a mutual agreement	https://drive.google.com/file/d/1LV3rxRskAi5igl9IMYUzUugl6SVgSaG5/view?usp=drivesdk
413	nêu rõ sở thích	to specify your preference	https://drive.google.com/file/d/1mogeocPyYlDDrcedQybSGFQEsJI8YXgT/view?usp=drivesdk
414	đi đến kết luận	to come to a conclusion	https://drive.google.com/file/d/1z68Qy2yt0pV10TOyUp597YbOet_vur2R/view?usp=drivesdk
415	sự thành công của quá trình hồi phục	the success of the recovery	https://drive.google.com/file/d/1n0yzTppqnUSHCPxKPh0KoWjlct5N2lly/view?usp=drivesdk
416	được hoàn trả chi phí đi lại	be reimbursed for travel expenses	https://drive.google.com/file/d/1FBUIm3BM7HRDTYYewCXBo-7cv7_-939n/view?usp=drivesdk
417	đạt thỏa thuận với công đoàn	to reach an agreement with the union	https://drive.google.com/file/d/1nBCCSUqNDb1OCE1aFm1qwWvvFJ7VwIuG/view?usp=drivesdk

`; // <-- THAY BẰNG DỮ LIỆU THẬT CỦA THẦY

  // ========= CODE CHUNG =========

 function normalize(str) {
  return (str || '')
    .normalize('NFC')                 // chuẩn hoá Unicode
    .replace(/[\u200B-\u200D\uFEFF]/g, '') // xoá ký tự zero-width
    .toLowerCase()
    .replace(/[’‘`]/g, "'")          // ’ ‘ `  -> '
    .replace(/\s+/g, ' ')
    .trim();
}


  function parseBank(raw) {
    const lines = raw.trim().split('\n').filter(l => l.trim() !== '');
    const items = [];
    lines.forEach(line => {
      const cols = line.split('\t');
      if (cols.length < 4) return;
      const id    = (cols[0] || '').trim();
      const vn    = (cols[1] || '').trim();
      const ans   = (cols[2] || '').trim();
      const audio = (cols[3] || '').trim();
      if (!vn || !ans) return;
      items.push({ id, vn, answer: ans, audio });
    });
    return items;
  }

  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

 
function sendLog(payload, useBeacon = false) {
  if (!LOG_ENDPOINT || !LOG_ENDPOINT.startsWith('http')) return;

  const data = JSON.stringify(payload);

  // Nếu dùng cho beforeunload thì ưu tiên sendBeacon
  if (useBeacon && navigator.sendBeacon) {
    navigator.sendBeacon(LOG_ENDPOINT, data);
  } else {
    // Còn lại dùng fetch bình thường
    fetch(LOG_ENDPOINT, {
      method: 'POST',
      mode: 'no-cors',
      keepalive: useBeacon,          // cho case beforeunload
      headers: { 'Content-Type': 'application/json' },
      body: data
    }).catch(() => {});
  }
}


 let bank = [];
let currentIndex = 0;
let correctCount = 0;
let totalDone = 0;
let quizFinished = false;

// Timer đếm lên
let startTime = null;
let timerInterval = null;
let elapsedSec = 0;        // số giây đã làm

// Đánh dấu đã ghi log hay chưa (để tránh ghi 2 lần)
let hasLogged = false;

  const vnTextEl = document.getElementById('vnText');
// LẤY IFRAME THAY VÌ AUDIO
const audioFrame = document.getElementById('audioFrame');
  const answerInput = document.getElementById('answerInput');
  const checkBtn = document.getElementById('checkBtn');
  const nextBtn = document.getElementById('nextBtn');
  const feedbackEl = document.getElementById('feedback');
  const correctCountEl = document.getElementById('correctCount');
  const totalDoneEl = document.getElementById('totalDone');
  const timerEl = document.getElementById('timer');
  const resultBox = document.getElementById('resultBox');
  const resultScore = document.getElementById('resultScore');
  const resultDetail = document.getElementById('resultDetail');

  document.getElementById('targetCorrectText').textContent = TARGET_CORRECT;
  document.getElementById('year').textContent = new Date().getFullYear();

function startTimer() {
  startTime = new Date();
  elapsedSec = 0;

  function renderTime() {
    const m = Math.floor(elapsedSec / 60);
    const s = elapsedSec % 60;
    timerEl.textContent =
      String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
  }

  renderTime();

  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    elapsedSec++;
    renderTime();
  }, 1000);
}

  
// Chuyển link Google Drive thành link preview cho iframe
function getDrivePreviewUrl(url) {
  if (!url) return '';
  url = url.trim();

  // Chỉ xử lý nếu là link Google Drive
  if (/drive\.google\.com/.test(url)) {
    let id = '';

    // Trường hợp: .../file/d/FILE_ID/view?...
    const m1 = url.match(/\/d\/([^\/]+)/);

    // Trường hợp: ...open?id=FILE_ID...
    const m2 = url.match(/[?&]id=([^&]+)/);

    if (m1 && m1[1]) {
      id = m1[1];
    } else if (m2 && m2[1]) {
      id = m2[1];
    }

    if (id) {
      // Link /preview cho iframe
      return 'https://drive.google.com/file/d/' + id + '/preview';
    }
  }

  // Nếu không phải Drive thì trả lại nguyên link
  return url;
}

  function showQuestion() {
  if (quizFinished) return;

  if (bank.length === 0) {
    vnTextEl.textContent = 'Không có câu hỏi nào trong ngân hàng.';
    return;
  }

  if (currentIndex >= bank.length) {
    shuffle(bank);
    currentIndex = 0;
  }

  const q = bank[currentIndex];
  vnTextEl.textContent = q.vn;

  // DÙNG LINK /preview CHO IFRAME
  const previewUrl = getDrivePreviewUrl(q.audio);
  audioFrame.src = previewUrl;

  answerInput.value = '';
  answerInput.disabled = false;
  answerInput.focus();

  feedbackEl.textContent = '';
  feedbackEl.className = '';
  checkBtn.disabled = false;
  nextBtn.style.display = 'none';
}



  function checkAnswer() {
    if (quizFinished) return;

    const name = (document.getElementById('studentName').value || '').trim();
    const cls  = (document.getElementById('studentClass').value || '').trim();
    if (!name || !cls) {
      alert('Vui lòng nhập HỌ TÊN và LỚP/NHÓM trước khi làm bài.');
      return;
    }

    const q = bank[currentIndex];
    const user = normalize(answerInput.value);
    if (!user) {
      alert('Hãy gõ đáp án trước khi bấm Check.');
      return;
    }

    // danh sách đáp án chấp nhận, phân biệt số ít/số nhiều (không can thiệp)
    const acceptable = q.answer
      .split('|')
      .map(a => normalize(a))
      .filter(a => a);

    totalDone++;
    const isCorrect = acceptable.includes(user);

    if (isCorrect) {
      correctCount++;
      feedbackEl.className = 'ok';
      feedbackEl.textContent = 'Đúng. Đáp án: ' + q.answer;
    } else {
      feedbackEl.className = 'ng';
      feedbackEl.textContent = 'Sai. Đáp án đúng: ' + q.answer;
    }

    correctCountEl.textContent = correctCount;
    totalDoneEl.textContent = totalDone;

    answerInput.disabled = true;
    checkBtn.disabled = true;
    nextBtn.style.display = 'inline-block';

    // >>> GHI LOG TIẾN ĐỘ MỖI LẦN HỌC SINH NHẤN CHECK
    logProgress();

    if (correctCount >= TARGET_CORRECT) {
      finishQuiz('Bạn đã hoàn thành đủ ' + TARGET_CORRECT + ' câu đúng.');
    }
  }

  function finishQuiz(reasonText) {
  if (quizFinished) return;
  quizFinished = true;
  hasLogged = true;   // đánh dấu đã ghi log để onbeforeunload không gửi nữa

  if (timerInterval) clearInterval(timerInterval);
  answerInput.disabled = true;
  checkBtn.disabled = true;
  nextBtn.disabled = true;

  const durationSec = elapsedSec;
  const percent = totalDone > 0
    ? Math.round((correctCount * 100) / totalDone)
    : 0;

  // Format thời gian: X phút YY giây (hiển thị cho học sinh)
  const mm = Math.floor(durationSec / 60);
  const ss = durationSec % 60;
  const timeText = `${mm} phút ${String(ss).padStart(2, '0')} giây`;

  resultBox.style.display = 'block';
  resultScore.textContent = `${percent}% chính xác`;
  resultDetail.innerHTML =
    `Bài test: <strong>${TEST_ID}</strong><br>` +
    `Đúng ${correctCount} / ${totalDone} câu.<br>` +
    `Thời gian làm bài: ${timeText}.<br>` +
    (reasonText ? `Kết thúc: ${reasonText}.` : '');

  const name = (document.getElementById('studentName').value || '').trim() || 'NoName';
  const cls  = (document.getElementById('studentClass').value || '').trim();
  const timestamp = new Date().toLocaleString();

  // hh:mm:ss cho log
  const hh = Math.floor(durationSec / 3600);
  const mm2 = Math.floor((durationSec % 3600) / 60);
  const ss2 = durationSec % 60;
  const durationHMS =
    String(hh).padStart(2, '0') + ':' +
    String(mm2).padStart(2, '0') + ':' +
    String(ss2).padStart(2, '0');

  const rawLog =
    name + '\t' +
    cls + '\t' +
    TEST_ID + '\t' +
    timestamp + '\t' +
    correctCount + '\t' +
    totalDone + '\t' +
    percent + '\t' +
    durationHMS;

  const payload = {
    attemptId: ATTEMPT_ID,   // rất quan trọng để ghi đè 1 dòng
    testId: TEST_ID,
    name: name,
    className: cls,
    correct: correctCount,
    total: totalDone,
    percent: percent,
    duration: durationSec,
    rawLog: rawLog,
    status: 'finished'
  };

  // Gửi log dùng fetch thường
  sendLog(payload, false);
}

// GHI LOG TIẾN ĐỘ MỖI LẦN NHẤN CHECK
function logProgress() {
  const name = (document.getElementById('studentName').value || '').trim() || 'NoName';
  const cls  = (document.getElementById('studentClass').value || '').trim();

  const durationSec = elapsedSec;
  const percent = totalDone > 0
    ? Math.round((correctCount * 100) / totalDone)
    : 0;

  const timestamp = new Date().toLocaleString();

  // Đổi duration sang hh:mm:ss để nhìn cho dễ trong RawLog
  const hh  = Math.floor(durationSec / 3600);
  const mm2 = Math.floor((durationSec % 3600) / 60);
  const ss2 = durationSec % 60;
  const durationHMS =
    String(hh).padStart(2, '0') + ':' +
    String(mm2).padStart(2, '0') + ':' +
    String(ss2).padStart(2, '0');

  const rawLog =
    name + '\t' +
    cls + '\t' +
    TEST_ID + '\t' +
    timestamp + '\t' +
    correctCount + '\t' +
    totalDone + '\t' +
    percent + '\t' +
    durationHMS;

  const payload = {
    attemptId: ATTEMPT_ID,   // cùng AttemptId -> luôn ghi đè 1 dòng
    testId: TEST_ID,
    name: name,
    className: cls,
    correct: correctCount,
    total: totalDone,
    percent: percent,
    duration: durationSec,
    rawLog: rawLog,
    status: 'progress'       // khác với finished / aborted
  };

  // Gửi log bình thường
  sendLog(payload, false);
}


  // ====== GẮN SỰ KIỆN ======
  checkBtn.addEventListener('click', checkAnswer);
  nextBtn.addEventListener('click', () => {
    if (quizFinished) return;
    currentIndex++;
    showQuestion();
  });

  answerInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      if (!checkBtn.disabled) {
        checkAnswer();
      } else if (!nextBtn.disabled && nextBtn.style.display !== 'none') {
        nextBtn.click();
      }
    }
  });

  // ====== KHỞI ĐỘNG ======
  (function init() {
    bank = parseBank(RAW_DATA);
    if (!bank.length) {
      vnTextEl.textContent = 'Không có dữ liệu trong RAW_DATA.';
      return;
    }
    shuffle(bank);
    startTimer();
    showQuestion();
  })();
document.getElementById('title').textContent = TEST_ID;

// ====== GHI LOG KHI HỌC SINH THOÁT GIỮA CHỪNG ======
window.addEventListener('beforeunload', (event) => {
  // Nếu đã finishQuiz() thì không log nữa
  if (hasLogged) return;

  // Nếu chưa làm gì (chưa trả lời câu nào) thì khỏi log
  if (totalDone === 0) return;

  const name = (document.getElementById('studentName').value || '').trim() || 'NoName';
  const cls  = (document.getElementById('studentClass').value || '').trim();

  const durationSec = elapsedSec;
  const percent = totalDone > 0
    ? Math.round((correctCount * 100) / totalDone)
    : 0;

  const timestamp = new Date().toLocaleString();

  // hh:mm:ss
  const hh = Math.floor(durationSec / 3600);
  const mm2 = Math.floor((durationSec % 3600) / 60);
  const ss2 = durationSec % 60;
  const durationHMS =
    String(hh).padStart(2, '0') + ':' +
    String(mm2).padStart(2, '0') + ':' +
    String(ss2).padStart(2, '0');

  const rawLog =
    name + '\t' +
    cls + '\t' +
    TEST_ID + '\t' +
    timestamp + '\t' +
    correctCount + '\t' +
    totalDone + '\t' +
    percent + '\t' +
    durationHMS + '\tThoát giữa chừng';

  const payload = {
    attemptId: ATTEMPT_ID,   // dùng cùng attemptId -> ghi đè đúng dòng
    testId: TEST_ID,
    name: name,
    className: cls,
    correct: correctCount,
    total: totalDone,
    percent: percent,
    duration: durationSec,
    rawLog: rawLog,
    status: 'aborted'
  };

  hasLogged = true;

  // Gửi log bằng sendBeacon (useBeacon = true)
  sendLog(payload, true);
});



  
</script>
</body>
</html>
